{{ with .Agregado -}}
<header class="relative flex items-center w-full bg-cyan-950 shadow-lg">
	<div class="p-1">
		<img class="w-24 rounded-md"
			alt="Portada del proyecto"
			data-proyecto-id="{{ .Proyecto.ProyectoID }}"
			src="{{ if .Proyecto.Imagen }}/imagenes/{{ .Proyecto.Imagen }}{{ else }}/assets/img/Elegantthemes-Softies-Tools.256.png{{ end }}"
			>
	</div>
	<div class="w-full p-2">
		<h2 class="text-2xl font-medium">
			<a href="/proyectos/{{ .Proyecto.ProyectoID }}">
				{{ enfatizar .Proyecto.Titulo }}
			</a>
		</h2>
		<h3 class="flex items-center gap-1 py-1"
			data-persona-id="{{ .Persona.PersonaID }}"
			>
			<span class="px-2 py-1 font-mono text-sm bg-black bg-opacity-40 rounded-md">
				<i class="fa-solid fa-person"></i>
			</span>
			<span class="text-xl">
				{{ .Persona.Nombre }}
			</span>
		</h3>
	</div>
	<span class="absolute right-2 top-2">
		<a class="px-2 py-1 transition-opacity bg-red-800 rounded-md opacity-75 hover:opacity-100"
			href="/"
			>
			<i class="fa-solid fa-xmark"></i>
		</a>
	</span>
</header>

<main class="grow w-full max-w-5xl p-2 mx-auto"
	hx-get="/historias/{{ .Historia.HistoriaID }}"
	hx-select="main"
	hx-swap="outerHTML"
	hx-target="this"
	hx-trigger="reloadHistoria"
	>

	<div class="flex flex-wrap justify-end gap-x-4 gap-y-2">
		<!--* PERSONA  -->
		<h4 class="grow">
			<a class="mx-1 rounded-md opacity-75 hover:opacity-100"
				href="/personas/{{ .Persona.PersonaID }}/doc#{{ .Historia.HistoriaID }}"
				title="Documentaci√≥n"
				>
				<i class="fa-solid fa-book"></i>
			</a>
			<span class="opacity-50">
				Como
			</span>
			<a class="text-lg lowercase transition-colors hover:text-cyan-600"
				href="/personas/{{ .Persona.PersonaID }}"
				{{ if not .Ancestros }}tipo="ancestro_directo"{{ end }}
				>
				{{- .Persona.Nombre -}}
			</a>
			<span class="opacity-50">
				quiero...
			</span>
		</h4>
		<!--* INSERTAR PADRE  -->
		<div>
			<button class="mx-1 rounded-md opacity-75 hover:opacity-100"
				hx-post="/historias/{{ .Historia.HistoriaID }}/padre"
				hx-prompt="Insertar historia padre con el t√≠tulo..."
				type="button"
				title="Insertar historia padre"
				>
				<i class="fa-solid fa-tree"></i>
			</button>
		</div>
		<!--* PRIORIDAD -->
		<div>
			<select class="form-control"
				hx-patch="/historias/{{ .Historia.HistoriaID }}/prioridad"
				hx-swap="none"
				name="value"
				>
				<option value="0" {{ if .Historia.EsPrioridadWont }}selected{{ end }}>
					üö´ Won't
				</option>
				<option value="1" {{ if .Historia.EsPrioridadCould }}selected{{ end }}>
					üò∂‚Äçüå´Ô∏è Could
				</option>
				<option value="2" {{ if .Historia.EsPrioridadShould }}selected{{ end }}>
					ü§î Should
				</option>
				<option value="3" {{ if .Historia.EsPrioridadMust }}selected{{ end }}>
					ü§© Must
				</option>
			</select>
		</div>
		<!--* COMPLETADA -->
		<div>
			<select class="form-control"
				hx-patch="/historias/{{ .Historia.HistoriaID }}/completada"
				hx-swap="none"
				name="value"
				>
				<option value="0">
					Pendiente
				</option>
				<option value="1" {{- if .Historia.Completada }}selected{{ end }}>
					‚úÖ Completada
				</option>
			</select>
		</div>
		<div class="flex items-center gap-1">
			<input class="form-control max-w-32"
				hx-askfor="reloadProgreso"
				hx-patch="/historias/{{ .Historia.HistoriaID }}/presupuesto"
				hx-swap="none"
				type="number"
				max="30"
				min="0"
				name="value"
				placeholder="Presupuesto"
				value="{{ if .Historia.SegundosPresupuesto }}{{ div .Historia.SegundosPresupuesto 3600 }}{{ end }}"
				>
			Hrs.
		</div>
	</div>

	<!--* ANCESTROS *-->
	{{ if .Ancestros }}
	<div class="pl-4">
		{{ range $i, $v := .Ancestros }}
		<ul class="pl-2 list-disc">
			<li class="pt-1">
				<a class="text-cyan-600 whitespace-pre-line transition-colors hover:text-cyan-400"
					href="/historias/{{ .HistoriaID }}"
					title="Ir al ancestro"
					{{ if eq (suma $i 1) (len $.Agregado.Ancestros) }}tipo="ancestro_directo"{{ end }}
					>
					{{- enfatizar .Titulo -}}...
				</a>
				{{ end }}
				{{ range .Ancestros -}}
			</li>
		</ul>
		{{ end }}
	</div>
	{{ end }}
	
	<!--* T√çTULO -->
	<div class="mt-2 mb-1">
		<textarea class="w-full px-2 py-1 text-2xl font-medium text-white bg-transparent border-b border-cyan-800 resize-none outline-hidden focus:border-blue-400"
			hx-patch="/historias/{{ .Historia.HistoriaID }}/titulo"
			hx-swap="none"
			enterkeyhint="enter"
			name="value"
			placeholder="Hacer algo de valor..."
			rows="1"
			title="T√≠tulo de la historia"
			>
			{{- .Historia.Titulo -}}
		</textarea>
	</div>

	<!--* CONTEXTO -->
	<div class="mb-4">
		<textarea class="w-full px-2 py-1 text-base font-medium bg-transparent border-b border-cyan-800 outline-hidden focus:border-blue-400 text-white/75 placeholder:text-slate-600"
			hx-patch="/historias/{{ .Historia.HistoriaID }}/objetivo"
			hx-swap="none"
			hx-trigger="change, keyup changed delay:60s"
			enterkeyhint="enter"
			name="value"
			placeholder="Porque me sirve para..."
			rows="1"
			title="Objetivo emp√°tico de la historia"
			>
			{{- .Historia.Objetivo -}}
		</textarea>
	</div>

	<!--* REGLAS DE NEGOCIO -->
	<ol id="reglasDeNegocio" tipo="sort_reglas" class="mb-6">
		{{ range .Reglas -}}
		<li tipo="sort_regla" class="flex gap-1 p-1 group">
			<div tipo="sort_handle" class="hidden transition-opacity opacity-0 cursor-pointer md:block group-hover:opacity-100"
				title="Posici√≥n {{ .Posicion }}"
				>
				‚£ø
				<form tipo="sort_form"
					hx-post="/reordenar-regla"
					hx-trigger="reordenarEnd"
					>
					<input
						type="hidden"
						name="historia_id"
						value="{{ .HistoriaID }}"
						>
					<input
						type="hidden"
						name="old_pos"
						value="{{ .Posicion }}"
						>
					<input
						type="hidden"
						name="new_pos"
						>
				</form>
			</div>
			<button class="pr-2"
				hx-patch="/historias/{{ .HistoriaID }}/reglas/{{ .Posicion }}/marcar"
				hx-select="#reglasDeNegocio"
				hx-target="#reglasDeNegocio"
				type="button"
				>
				{{ if and .Implementada .Probada }}
				<i class="text-sm text-green-500 fa-solid fa-arrow-right"></i>
				{{ else if .Implementada }}
				<i class="text-sm text-orange-500 fa-solid fa-arrow-right"></i>
				{{ else }}
				<i class="text-sm text-slate-400 fa-solid fa-arrow-right"></i>
				{{ end }}
			</button>
			<textarea id="input_Regla{{ .Posicion }}" class="inline-block w-full text-white bg-transparent border-b border-transparent outline-hidden read-only:border-transparent invalid:border-red-500 invalid:focus:border-red-500 placeholder:text-slate-600 read-only:focus:border-transparent focus:border-blue-400"
				hx-patch="/historias/{{ .HistoriaID }}/reglas/{{ .Posicion }}"
				hx-select="#reglasDeNegocio"
				hx-target="#reglasDeNegocio"
				enterkeyhint="enter"
				name="texto"
				rows="1"
				>
				{{- .Texto -}}
			</textarea>
			<button class="hidden ml-2 transition opacity-0 cursor-pointer md:block group-hover:opacity-80 focus:opacity-80 hover:text-red-600"
				hx-confirm="¬øEliminar regla? {{ .Texto }}"
				hx-delete="/historias/{{ .HistoriaID }}/reglas/{{ .Posicion }}"
				hx-select="#reglasDeNegocio"
				hx-target="#reglasDeNegocio"
				type="button"
				title="Quitar regla"
				>
				<i class="fa-solid fa-trash"></i>
			</button>
		</li>
		{{ end }}
		<li class="flex items-center gap-1 p-1">
			<div class="hidden opacity-0 md:block">
				‚£ø
			</div>
			<div class="pr-2">
				<i class="text-sm text-slate-400 fa-solid fa-arrow-right"></i>
			</div>
			<textarea id="input_AddRegla" class="inline-block w-full bg-transparent border-b border-transparent outline-hidden text-white/50 focus:text-white read-only:border-transparent invalid:border-red-500 invalid:focus:border-red-500 placeholder:text-slate-600 read-only:focus:border-transparent focus:border-blue-400"
				hx-post="/historias/{{ .Historia.HistoriaID }}/reglas"
				hx-select="#reglasDeNegocio"
				hx-target="#reglasDeNegocio"
				hx-trigger="keyup[key=='Enter']"
				enterkeyhint="enter"
				name="texto"
				placeholder="Agregar regla"
				rows="1"
				></textarea>
		</li>
	</ol>

	<!--* AVANCE  -->
	<div id="progreso"
		hx-get="/historias/{{ .Historia.HistoriaID }}"
		hx-select="#progreso"
		hx-swap="outerHTML"
		hx-target="#progreso"
		hx-trigger="reloadProgreso from:body"
		>
		<!-- Cargar librer√≠a desde antes -->
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

		{{ if .SegundosPresupuesto }}
		<h3 class="mb-4 text-xl text-cyan-600">
			<a href="#progreso">
				Progreso
			</a>
		</h3>
		<!-- Tarjetas avance -->
		<div class="flex flex-wrap justify-around gap-4 mb-4 text-4xl">
			<div class="flex flex-col items-center justify-center p-4 px-6 bg-cyan-800 rounded-lg shadow-md">
				<span class="text-3xl font-bold text-white">
					{{ .AvancePorcentual }}%
				</span>
				<span class="text-sm text-cyan-200">
					Avance
				</span>
			</div>
			<div class="flex flex-col items-center justify-center p-4 px-6 bg-cyan-800 rounded-lg shadow-md">
				<span class="text-3xl font-bold text-white">
					{{ segundosToString .SegundosPresupuesto }}
				</span>
				<span class="text-sm text-cyan-200">
					Presupuesto
				</span>
			</div>
			<div class="flex flex-col items-center justify-center p-4 px-6 bg-cyan-800 rounded-lg shadow-md">
				<span class="text-3xl font-bold text-white">
					{{ segundosToString .SegundosEstimado }}
				</span>
				<span class="text-sm text-cyan-200">
					Estimaci√≥n
				</span>
			</div>
			<div class="flex flex-col items-center justify-center p-4 px-6 bg-cyan-800 rounded-lg shadow-md">
				<span class="text-3xl font-bold {{ if gt .SegundosUtilizado (suma .SegundosPresupuesto 3600) }} text-red-400 {{ else if gt .SegundosUtilizado .SegundosPresupuesto }} text-orange-400 {{ else }} text-white {{ end }}">
					{{ segundosToString .SegundosUtilizado }}
				</span>
				<span class="text-sm text-cyan-200">
					Utilizado
				</span>
			</div>
		</div>
		<!-- Gr√°fico avance -->
		<div class="w-full h-24 px-4 mb-6 bg-transparent">
			<canvas id="chartAvanceHistoria"></canvas>
		</div>
		<script defer>
			new Chart(document.getElementById('chartAvanceHistoria'), {
				type: 'bar',
				data: {
					labels: [''],
					datasets: [
						{
							// MARCA DE TIEMPO ESTIMADO
							data: [{{ .HorasEstimado }}],
							label: 'Estimado',
							categoryPercentage: 1,
							backgroundColor: 'transparent',
							borderWidth: {top: 0, right: 2, bottom: 0, left: 0},
							borderColor: 'gray',
						},
						{
							// MARCA DE EXPECTATIVA SEG√öN AVANCE Y PRESUPUESTO
							data: [{{ .HorasExpectativaAvancePresupuesto }}],
							label: 'Avance obtenido',
							categoryPercentage: 1,
							backgroundColor: 'transparent',
							borderWidth: {top: 0, right: 3, bottom: 0, left: 0},
							borderColor: 'lime',
						},
						{
							// RECUADRO DE PRESUPUESTO
							data: [{{ .HorasPresupuesto }}],
							label: 'Presupuesto',
							categoryPercentage: 1,
							backgroundColor: 'transparent',
							borderWidth: {top: 2, right: 5, bottom: 2, left: 0},
							borderColor: 'lightblue',
						},
						{
							// RELLENO UTILIZADO
							data: [{{ .HorasUtilizado }}],
							label: 'Utilizado',
							backgroundColor: '#155e75',
							categoryPercentage: 1,
						},
					]
				},
				options: {
					indexAxis: 'y',
					barThickness: 30,
					elements: {
						bar: {
						}
					},
					responsive: true,
					maintainAspectRatio: false,
					scales: {
						y: {
							stacked: true,
							ticks: {
								color: 'white'
							},
							grid: {
								display: false,
							},
							border: {
								color: 'white',
								width: 2,
							},
						},
						x: {
							beginAtZero: true,
							grid: {
								drawOnChartArea: false,
								color: 'white',
								lineWidth: 2,
							},
							border: {
								display: false,
							},
							ticks: {
								color: 'white',
								callback: function(value, index, ticks) {
									return this.getLabelForValue(value) + " h";
								},
							},
						}
					},
					plugins: {
						legend: {
							display: false,
							position: 'top',
							labels: {
								color: 'white',
								boxWidth: 20,
							}
						},
						title: {
							display: false,
						},
						tooltip: {
							enabled: false,
						},
					}
				},
			});
		</script>
		{{ end }}
	</div>

	<!--* VIAJE DE USUARIO *-->
	<h3 class="mb-2 text-xl text-cyan-600 group">
		Viaje de usuario
		<a class="mx-1 text-base opacity-0 group-hover:opacity-100 focus:opacity-100"
			href="/personas/{{ .Persona.PersonaID }}/doc#{{ .Historia.HistoriaID }}"
			title="Ver en documentaci√≥n"
			>
			<i class="fa-solid fa-book"></i>
		</a>
	</h3>
	<div class="mb-2">
		<textarea class="w-full px-2 py-1 text-base font-medium bg-transparent border-b border-cyan-800 outline-hidden focus:border-blue-400 text-white/75 placeholder:text-slate-600"
			hx-patch="/historias/{{ .Historia.HistoriaID }}/descripcion"
			hx-swap="none"
			hx-trigger="change, keyup changed delay:60s"
			enterkeyhint="enter"
			name="value"
			placeholder="Descripci√≥n para el usuario en infinitivo..."
			rows="1"
			title="Descripci√≥n de la historia"
			>
			{{- .Historia.Descripcion -}}
		</textarea>
	</div>
	<ol id="viajeList" tipo="sort_tramos" class="mb-6">
		{{ range .Tramos -}}
		<li tipo="sort_tramo" class="flex flex-col items-start">
			<div class="flex w-full gap-1 p-1 group">
				<div tipo="sort_handle" class="hidden transition-opacity opacity-0 cursor-pointer md:block group-hover:opacity-100">
					‚£ø
					<form tipo="sort_form"
						hx-post="/reordenar-tramo"
						hx-select="#viajeList"
						hx-target="#viajeList"
						hx-trigger="reordenarEnd"
						>
						<input
							type="hidden"
							name="historia_id"
							value="{{ .HistoriaID }}"
							>
						<input
							type="hidden"
							name="old_pos"
							value="{{ .Posicion }}"
							>
						<input
							type="hidden"
							name="new_pos"
							>
					</form>
				</div>
				<div>
					<span class="px-2 py-1 mr-1 font-mono text-xs rounded-md opacity-50 bg-black/50 whitespace-nowrap">
						{{ .Posicion }}
					</span>
				</div>
				<textarea id="input_Tramo{{ .Posicion }}" class="inline-block w-full text-white bg-transparent border-b border-transparent outline-hidden read-only:border-transparent invalid:border-red-500 invalid:focus:border-red-500 placeholder:text-slate-600 read-only:focus:border-transparent focus:border-blue-400"
					hx-patch="/historias/{{ .HistoriaID }}/viaje/{{ .Posicion }}"
					hx-select="#viajeList"
					hx-target="#viajeList"
					enterkeyhint="enter"
					name="texto"
					rows="1"
					>
					{{- .Texto -}}
				</textarea>
				<div class="flex gap-2">
					{{ if not .Imagen -}}
					<button class="ml-1 transition-opacity opacity-0 cursor-pointer group-hover:opacity-80 focus:opacity-80"
						type="button"
						onclick="showTramoImgModal(this.closest('li'))"
						title="Definir imagen"
						>
						<i class="fa-solid fa-image"></i>
					</button>
					{{ end }}
					<button class="ml-1 transition-opacity opacity-0 cursor-pointer group-hover:opacity-80 focus:opacity-80"
						type="button"
						onclick="showMoverTramo('{{ .HistoriaID }}','{{ .Posicion }}','{{ .Texto }}')"
						title="Mover tarea"
						>
						<i class="fa-solid fa-person-walking"></i>
					</button>
				</div>
			</div>
			{{ if .Imagen -}}
			<div class="relative mb-2 ml-12 border border-cyan-800 rounded-md shadow-lg">
				<img class="rounded-md cursor-pointer max-w-40 max-h-40"
					onclick="showTramoImgModal(this.closest('li'))"
					src="/imagenes/{{ .Imagen }}"
					>
			</div>
			{{ end }}
		</li>
		{{ end }}
		
		<!-- Agregar tramo... -->
		<li class="flex items-center gap-1 p-1">
			<div class="hidden opacity-0 md:block">
				‚£ø
			</div>
			<div>
				<span class="px-2 py-1 mr-1 font-mono text-xs rounded-md opacity-50 bg-black/50 whitespace-nowrap">
					{{ suma (len .Tramos) 1 }}
				</span>
			</div>
			<textarea id="input_AddTramo" class="inline-block w-full bg-transparent border-b border-transparent outline-hidden text-white/50 focus:text-white read-only:border-transparent invalid:border-red-500 invalid:focus:border-red-500 placeholder:text-slate-600 read-only:focus:border-transparent focus:border-blue-400"
				hx-post="/historias/{{ .Historia.HistoriaID }}/viaje"
				hx-select="#viajeList"
				hx-target="#viajeList"
				hx-trigger="keyup[key=='Enter']"
				enterkeyhint="enter"
				name="texto"
				placeholder="Agregar un tramo al viaje"
				rows="1"
				></textarea>
		</li>
	</ol>

	<!--* IMAGEN DEL TRAMO -->
	<dialog id="TramoImgModal" class="w-full max-w-3xl m-auto text-white bg-cyan-900 border-4 border-cyan-800 rounded-md">
		<div class="flex flex-col max-w-3xl max-h-[90vh]">
			<!-- Para hacer scrollable manteniendo header -->
			<header class="flex items-center gap-2 p-2 bg-cyan-800">
				<h2 class="grow text-xl">
					Viaje de usuario
				</h2>
				<button class="inline-block float-right px-2 text-lg rounded-md hover:opacity-75"
					type="button"
					title="Anterior"
					>
					<i class="fa-solid fa-arrow-left"></i>
				</button>
				<button class="inline-block float-right px-2 text-lg rounded-md hover:opacity-75"
					type="button"
					title="Siguiente"
					>
					<i class="fa-solid fa-arrow-right"></i>
				</button>
				<button class="inline-block float-right px-2 text-2xl rounded-md hover:opacity-75"
					type="button"
					onclick="this.closest('dialog').close()"
					title="Cerrar"
					>
					<i class="fa-solid fa-xmark"></i>
				</button>
			</header>
			<div class="flex flex-col grow gap-2 p-2 overflow-y-auto">
				<p>
					<!-- Datos puestos con JS -->
				</p>
				<img class="mx-auto border border-cyan-800 rounded-md shadow-lg"
					src=""
					>
				<form id="formSubirImagen" class="py-2 text-center"
					hx-encoding="multipart/form-data"
					hx-post="/imagenes"
					hx-select="#viajeList"
					hx-target="#viajeList"
					>
					<input
						type="hidden"
						name="historia_id"
						>
					<input
						type="hidden"
						name="posicion"
						>
					<input class="form-control"
						type="file"
						accept="image/png, image/jpeg, image/gif"
						name="imagen"
						onchange="showTramoImagePreview(this)"
						required
						>
				</form>
				<div class="flex flex-row-reverse flex-wrap justify-center gap-x-4 gap-y-2">
					<button tipo="btn_subir_imagen" class="grow p-2 text-lg font-semibold transition-colors bg-cyan-700 rounded-sm shadow-md hover:bg-cyan-600"
						type="submit"
						form="formSubirImagen"
						onclick="this.closest('dialog').close()"
						>
						Guardar
					</button>
					<button tipo="cancelar" class="inline-block px-6 py-2 text-slate-100 transition-colors bg-gray-600 rounded-sm shadow-md hover:bg-gray-500"
						onclick="this.closest('dialog').close()"
						>
						Cancelar
					</button>
					<button tipo="eliminar_img" class="px-6 py-2 font-semibold text-red-400 transition-colors rounded-sm shadow-md hover:bg-red-500 hover:text-white"
						hx-confirm="¬øEliminar esta imagen?"
						hx-select="#viajeList"
						hx-target="#viajeList"
						hx-trigger="click"
						type="button"
						onclick="this.closest('dialog').close()"
						title="Quitar imagen"
						>
						Quitar imagen
					</button>
				</div>
			</div>
		</div>
	</dialog>

	<!--* DESCENDIENTES *-->
	<h3 class="mb-2 text-xl text-cyan-600">
		Descendientes
	</h3>
	<ul id="descendientesList" tipo="sort_descendientes" class="mb-6"
		hx-select="#descendientesList"
		hx-target="#descendientesList"
		hx-select-oob="#descendientesMenus"
		>
		{{ range .Descendientes }}
		<li tipo="sort_descendiente" class="">
			<div class="flex gap-1 p-1 group">
				<div tipo="sort_handle" class="hidden transition-opacity opacity-0 cursor-pointer md:block group-hover:opacity-100">
					‚£ø
					<form tipo="sort_form"
						hx-post="/reordenar-historia"
						hx-trigger="reordenarEnd"
						>
						<input
							type="hidden"
							name="historia_id"
							value="{{ .HistoriaID }}"
							>
						<input
							type="hidden"
							name="old_pos"
							value="{{ .Posicion }}"
							>
						<input
							type="hidden"
							name="new_pos"
							>
					</form>
				</div>
				<button tipo="descendiente_bullet" class="inline-block w-5 text-center"
					type="button"
					onclick="showMenuHistoria({{ .HistoriaID }})"
					>
					{{- if .Completada }}
					<i class="text-green-600 fa-solid fa-circle-check"></i>
					{{- else if .EsPrioridadMust }}
					<i class="text-orange-600 fa-solid fa-angles-up"></i>
					{{- else if .EsPrioridadShould }}
					<i class="text-orange-400 fa-solid fa-chevron-up"></i>
					{{- else if .EsPrioridadCould }}
					<i class="text-orange-200 fa-solid fa-minus"></i>
					{{- else }}
					<i class="text-slate-400 fa-solid fa-ban"></i>
					{{- end }}
				</button>
				<div class="grow">
					<a class="text-cyan-400 whitespace-pre-line hover:text-cyan-300"
						href="/historias/{{ .HistoriaID }}"
						>
						{{- enfatizar .Titulo -}}
					</a>
					<span class="float-right text-sm opacity-75">
						{{ if .SegundosPresupuesto }}{{ segundosToString .SegundosPresupuesto }}{{ end }}
					</span>
				</div>
			</div>

			<!--* DESC NIVEL DOS  -->
			{{ if .Descendientes -}}
			<ul class="">
				{{ range .Descendientes }}
				<li class="flex gap-1 p-1 group">
					<div class="pl-8">
						<button tipo="descendiente_bullet" class="inline-block w-5 text-center"
							type="button"
							onclick="showMenuHistoria({{ .HistoriaID }})"
							>
							{{- if .Completada }}
							<i class="text-green-600 fa-solid fa-circle-check"></i>
							{{- else if .EsPrioridadMust }}
							<i class="text-orange-600 fa-solid fa-angles-up"></i>
							{{- else if .EsPrioridadShould }}
							<i class="text-orange-400 fa-solid fa-chevron-up"></i>
							{{- else if .EsPrioridadCould }}
							<i class="text-orange-200 fa-solid fa-minus"></i>
							{{- else }}
							<i class="text-slate-400 fa-solid fa-ban"></i>
							{{- end }}
						</button>
					</div>
					<div class="grow">
						<a class="font-light text-cyan-400 whitespace-pre-line hover:text-cyan-300"
							href="/historias/{{ .HistoriaID }}"
							>
							{{- enfatizar .Titulo -}}
						</a>
						<span class="float-right text-xs opacity-50">
							{{ if .SegundosPresupuesto }}{{ segundosToString .SegundosPresupuesto }}{{ end }}
						</span>
					</div>
				</li>
				{{ end }}
			</ul>
			{{ end }}
		</li>
		{{ end }}
		
		<li class="">
			<div class="flex gap-1 p-1 group">
				<div class="hidden opacity-0 md:block">
					‚£ø
				</div>
				<span class="inline-block w-5 text-center">
					<i class="w-5 text-sm text-slate-400 fa-solid fa-arrow-right"></i>
				</span>
				<textarea class="inline-block w-full bg-transparent border-b border-transparent outline-hidden text-white/50 focus:text-white read-only:border-transparent invalid:border-red-500 invalid:focus:border-red-500 placeholder:text-slate-600 read-only:focus:border-transparent focus:border-blue-400"
					hx-post="/historias/{{ .Historia.HistoriaID }}"
					hx-trigger="keyup[key=='Enter']"
					enterkeyhint="enter"
					name="titulo"
					placeholder="Agregar historia"
					rows="1"
					></textarea>
			</div>
		</li>
	</ul>

	<!-- Men√∫ contextextual de descendientes -->
	<div id="descendientesMenus"
		hx-askfor="/historias/{{ .Historia.HistoriaID }}"
		hx-select="#descendientesList"
		hx-target="#descendientesList"
		hx-select-oob="#descendientesMenus"
		>
		{{ range .Descendientes -}}
			{{ template "ctxMenuHistoria" . -}}
			{{ range .Descendientes -}}
				{{ template "ctxMenuHistoria" . -}}
			{{ end }}
		{{ end }}
	</div>

	<!--* RELACIONADAS *-->
	<h3 class="mb-2 text-xl text-cyan-600 group">
		Relacionadas
		<button class="ml-2 text-base transition-opacity opacity-0 group-hover:opacity-100 focus:opacity-100 hover:text-cyan-300"
			type="button"
			onclick="showAddReferencia()"
			title="Agregar historia relacionada"
			>
			<i class="fa-solid fa-square-plus"></i>
		</button>
	</h3>
	<ul id="relacionadasList" class="mb-6">
		{{ range .Relacionadas -}}
		<li class="flex gap-1 p-1 group">
			<div class="pr-2 md:pl-4">
				<i class="text-xs text-slate-400 fa-solid fa-circle"></i>
			</div>
			<div class="grow">
				<a class="text-cyan-400 whitespace-pre-line hover:text-cyan-300"
					href="/historias/{{ .HistoriaID }}"
					>
					{{- enfatizar .Titulo -}}
				</a>
			</div>
			<button class="hidden ml-2 transition opacity-0 cursor-pointer md:block group-hover:opacity-80 focus:opacity-80 hover:text-red-600"
				hx-delete="/historias/{{ $.Agregado.Historia.HistoriaID }}/referencias/{{ .HistoriaID }}"
				hx-select="#relacionadasList"
				hx-target="#relacionadasList"
				type="button"
				title="Quitar historia relacionada"
				>
				<i class="fa-solid fa-trash"></i>
			</button>
		</li>
		{{ end }}
	</ul>

	<!--* IMPLEMENTACI√ìN -->
	<div id="implementacion">
		<h3 class="text-xl text-cyan-600 mb-2">
			<a href="#implementacion">
				Implementaci√≥n
			</a>
			{{ if .Historia.Notas -}}
			<button class="mx-2 text-base hover:text-cyan-300 float-right"
				type="button"
				onclick="editNotasImplementacion(this)"
				title="Editar notas"
				>
				<i class="fa-solid fa-pencil"></i>
			</button>
			{{ end -}}
			<button id="viewNotasBtn" class="mx-2 text-base hover:text-cyan-300 float-right hidden"
				type="button"
				hx-get="/historias/{{ .Historia.HistoriaID }}"
				hx-select="#implementacion"
				hx-target="#implementacion"
				title="Ver con formato"
				>
				<i class="fa-solid fa-eye"></i>
			</button>
		</h3>
		{{ if .Historia.Notas -}}
		<p id="notasImplView" class="px-2 py-1 mb-1 whitespace-pre-line">
			{{- enfatizar .Historia.Notas -}}
		</p>
		{{ end -}}
		<div id="notasImplEdit" class="{{ if .Historia.Notas -}}hidden{{ end }}">
			<textarea class="w-full px-2 py-1 text-base font-medium bg-transparent border-b border-cyan-800 outline-hidden focus:border-blue-400 text-white/75 placeholder:text-slate-600"
				hx-patch="/historias/{{ .Historia.HistoriaID }}/notas"
				hx-swap="none"
				hx-trigger="change, keyup changed delay:60s"
				enterkeyhint="enter"
				name="value"
				placeholder="Notas de implementaci√≥n..."
				rows="1"
				title="Detalles de implementaci√≥n"
				onchange="let btn = document.getElementById('viewNotasBtn'); if(this.value.trim() !== '') { btn.classList.remove('hidden'); } else { btn.classList.add('hidden'); }"
				>
				{{- .Historia.Notas -}}
			</textarea>
		</div>
		<script>
			function editNotasImplementacion(btn) {
				const editNotasDiv = document.getElementById('notasImplEdit')
				editNotasDiv.classList.remove('hidden');
				document.getElementById('notasImplView').classList.add('hidden');
				btn.classList.add('hidden');
				const textarea = editNotasDiv.querySelector('textarea');
				textarea.focus();
				textarea.setSelectionRange(textarea.value.length, textarea.value.length);
				document.getElementById('viewNotasBtn').classList.remove('hidden');
			}
		</script>
	</div>

	<!--* TAREAS -->
	<div class="flex flex-wrap items-baseline gap-4 mb-2 text-cyan-600">
		<h3 id="tareas" class="grow text-xl">
			<a href="#tareas">
				Tareas
			</a>
		</h3>
		<span class="text-sm opacity-75">
			<i class="fa-solid fa-list-check"></i>
			Progreso
			{{ .Tareas.AvancePorcentual }}%
		</span>
		{{- if .Tareas.SegundosUtilizado -}}
		<span class="text-sm opacity-75"
			title="Tiempo transcurrido {{ segundosToString .Tareas.SegundosUtilizado }}"
			>
			<i class="fa-solid fa-stopwatch"></i>
			Transcurrido
			{{ segundosToString .Tareas.SegundosUtilizado }}
		</span>
		{{- end -}}
		{{- if .Tareas.SegundosEstimado -}}
		<span class="text-sm opacity-75">
			<i class="fa-solid fa-hourglass-start"></i>
			Estimado
			{{ segundosToString .Tareas.SegundosEstimado }}
		</span>
		{{- end -}}
	</div>
	<ol id="tareasList" class="mb-6"
		hx-select="#tareasList"
		hx-target="#tareasList"
		hx-select-oob="#tareasDialogs"
		hx-swap="innerHTML"
		>
		{{ range .Tareas }}
		<li id="{{ .TareaID }}" tipo="sort_tarea" class="flex gap-1 p-1 group">
			<div tipo="sort_handle" class="hidden transition-opacity opacity-0 cursor-pointer md:block group-hover:opacity-100">
				‚£ø
				<form tipo="sort_form"
					hx-post="/reordenar-tarea"
					hx-trigger="reordenarEnd"
					>
					<input
						type="hidden"
						name="historia_id"
						value="{{ .HistoriaID }}"
						>
					<input
						type="hidden"
						name="new_pos"
						>
				</form>
			</div>
			<div>
				<span class="inline-block w-6 text-center">
					{{- if .Finalizada }}
					<i class="text-green-600 fa-regular fa-square-check"></i>
					{{ else if .EnCurso }}
					<i class="text-green-600 fa-regular fa-square"></i>
					{{ else if .EnPausa }}
					<i class="text-orange-600 fa-regular fa-square"></i>
					{{ else }}
					<i class="text-slate-400 fa-regular fa-square"></i>
					{{ end -}}
				</span>
			</div>
			<p class="">
				<button class="px-2 py-1 text-xs font-semibold leading-none text-cyan-600 bg-cyan-950 rounded-md"
					hx-post="/tareas/{{ .TareaID }}/importancia"
					tabindex="-1"
					title="{{ $.Agregado.Tareas.ValorPorcentual .TareaID }}% del trabajo"
					>
					{{- .Importancia.Etiqueta -}}
				</button>

				{{ if not .Tipo.EsIndefinido -}}
				<span class="px-2 py-1 text-xs font-semibold leading-none text-cyan-600 bg-cyan-950 rounded-md">
					{{- .Tipo.Etiqueta -}}
				</span>
				{{ end }}
				
				<span class="cursor-pointer {{ if .Finalizada }} opacity-50 line-through {{ end }}"
					onclick="document.getElementById('edit{{ .TareaID }}').showModal()"
					>
					{{ .Descripcion }}
				</span>

				{{- if .EnCurso -}}
				<span class="mx-2 opacity-50">
					<img class="inline-block w-8"
						alt="En progreso"
						src="/assets/img/spinner.svg"
						>
				</span>
				{{- end -}}
				
				<span class="float-right sm:hidden">
					{{- if .SegundosEstimado -}}
					<span class="pl-4 text-sm opacity-75 whitespace-nowrap"
						title="Tiempo estimado {{ segundosToString .SegundosEstimado }}"
						>
						<i class="fa-solid fa-hourglass-start"></i>
						{{ segundosToString .SegundosEstimado }}
					</span>
					{{- end -}}
					{{- if .SegundosUtilizado -}}
					<button class="pl-4 text-sm opacity-75 whitespace-nowrap"
						onclick="showIntervalos('{{ .TareaID }}')"
						title="Tiempo transcurrido {{ segundosToString .SegundosUtilizado }}"
						>
						<i class="fa-solid fa-stopwatch"></i>
						{{ segundosToString .SegundosUtilizado }}
					</button>
					{{- end -}}
				</span>

				{{ if and .Impedimentos (not .Finalizada) -}}
				<br>
				<i class="text-sm text-orange-300">
					{{ .Impedimentos }}
				</i>
				{{- end }}
				
				<!-- <span class="px-2 py-1 text-xs font-semibold leading-none text-white bg-cyan-950 rounded-md opacity-50">
					e:{{ .SegundosEstimado }}
					r:{{ .SegundosUtilizado }}
					v:{{ .ValorPonderado }}
					a:{{ .AvancePonderado }}
					{{ $.Agregado.Tareas.ValorPorcentual .TareaID }}%
				</span> -->
			</p>
			<div class="items-start hidden gap-2 md:flex">
				{{ if .NoIniciada -}}
				<button class="inline-block px-2 text-lg text-slate-100 transition-opacity shadow-md opacity-0 group-hover:opacity-80 focus:opacity-100"
					hx-post="/tareas/{{ .TareaID }}/iniciar"
					type="button"
					title="Iniciar tarea"
					>
					<i class="fa-solid fa-play"></i>
				</button>
				{{ else if .EnCurso -}}
				<button class="inline-block px-2 text-lg text-slate-100 transition-opacity shadow-md opacity-0 group-hover:opacity-80 focus:opacity-100"
					hx-post="/tareas/{{ .TareaID }}/pausar"
					type="button"
					title="Pausar tarea"
					>
					<i class="fa-solid fa-pause"></i>
				</button>
				<button class="inline-block px-2 text-lg text-slate-100 transition-opacity shadow-md opacity-0 group-hover:opacity-80 focus:opacity-100"
					hx-post="/tareas/{{ .TareaID }}/terminar"
					type="button"
					title="Marcar como finalizada"
					>
					<i class="fa-solid fa-square-check"></i>
				</button>
				{{ else if .EnPausa -}}
				<button class="inline-block px-2 text-lg text-slate-100 transition-opacity shadow-md opacity-0 group-hover:opacity-80 focus:opacity-100"
					hx-post="/tareas/{{ .TareaID }}/iniciar"
					type="button"
					title="Iniciar tarea"
					>
					<i class="fa-solid fa-play"></i>
				</button>
				{{ else if .Finalizada -}}
				<button class="inline-block px-2 text-lg text-slate-100 transition-opacity shadow-md opacity-0 group-hover:opacity-80 focus:opacity-100"
					hx-post="/tareas/{{ .TareaID }}/iniciar"
					type="button"
					title="Iniciar tarea"
					>
					<i class="fa-solid fa-play"></i>
				</button>
				{{ end }}
			</div>
			<div class="grow hidden text-right sm:block">
				{{- if .SegundosUtilizado -}}
				<button class="pl-4 text-sm opacity-75 whitespace-nowrap"
					onclick="showIntervalos('{{ .TareaID }}')"
					title="Tiempo transcurrido {{ segundosToString .SegundosUtilizado }}"
					>
					<i class="fa-solid fa-stopwatch"></i>
					{{ segundosToString .SegundosUtilizado }}
				</button>
				{{- end -}}
				<button class="pl-4 text-sm opacity-75 whitespace-nowrap"
					hx-patch="/tareas/{{ .TareaID }}/estimado"
					hx-prompt="Nuevo estimado"
					title="Tiempo estimado {{ segundosToString .SegundosEstimado }}"
					>
					<i class="fa-solid fa-hourglass-start"></i>
					{{ if .SegundosEstimado }}{{ segundosToString .SegundosEstimado }}{{ else }}1h{{ end -}}
				</button>
			</div>
		</li>
		{{ end }}
		<li class="flex items-center gap-1 p-1">
			<div class="hidden opacity-0 md:block">
				‚£ø
			</div>
			<div>
				<span class="inline-block w-6 text-center">
					<i class="text-slate-400 fa-regular fa-square"></i>
				</span>
			</div>
			<input id="input_AddTarea" class="inline-block w-full text-white bg-transparent border-b border-cyan-800 outline-hidden invalid:border-red-500 invalid:focus:border-red-500 placeholder:text-slate-600 focus:border-blue-400"
				hx-include="closest li"
				hx-on:htmx:validation:validate="if(this.value == '') { this.setCustomValidity('Introduzca un valor'); this.reportValidity(); this.addEventListener('input',function fn(){ console.log('input'); this.setCustomValidity(''); this.removeEventListener('input',fn); }); }"
				hx-post="/historias/{{ .Historia.HistoriaID }}/tareas"
				hx-trigger="keyup[key=='Enter']"
				hx-validate="true"
				type="text"
				name="descripcion"
				placeholder="Agregar tarea"
				>
			<input class="inline-block text-white bg-transparent border-b border-cyan-800 outline-hidden invalid:border-red-500 invalid:focus:border-red-500 placeholder:text-slate-600 focus:border-blue-400"
				hx-include="closest li"
				hx-post="/historias/{{ .Historia.HistoriaID }}/tareas"
				hx-trigger="keyup[key=='Enter']"
				hx-validate="true"
				type="text"
				name="segundos_estimado"
				placeholder="‚è± Estimado"
				>
		</li>
	</ol>

	{{ if and (not .Historia.Descripcion) (not .Historia.Objetivo) (not .Historia.Notas) (not .Reglas) (not .Descendientes) (not .Tramos) (not .Relacionadas) (not .Tareas) -}}
	<div class="text-center">
		<button class="px-4 py-2 transition-opacity bg-red-800 rounded-md opacity-75 hover:opacity-100"
			hx-confirm="¬øEliminar historia vac√≠a?"
			hx-delete="/historias/{{ .Historia.HistoriaID }}"
			type="button"
			>
			<i class="mr-2 fa-solid fa-trash"></i>
			Eliminar historia
		</button>
	</div>
	{{ end }}
	

</main>
{{ end }}

<!-- Editar tareas -->
<div id="tareasDialogs"
	hx-select="#tareasList"
	hx-target="#tareasList"
	hx-select-oob="#tareasDialogs"
	>
	{{ range $.Agregado.Tareas -}}
	{{ template "tarea_editar_dialog" . }}
	{{ end }}
</div>

<!-- Administrar intervalos -->
{{ block "intervalos_dialog" . }}
<dialog id="modalIntervalos" class="m-auto text-white bg-cyan-900 border-4 border-cyan-800 rounded-md">
	<div id="intervalosList"
		hx-swap="innerHTML"
		hx-target="this"
		hx-trigger="cargarIntervalos"
		>
		Cargando...
	</div>
</dialog>
<script>
	function showIntervalos(tareaID) {
		document.getElementById("modalIntervalos").showModal()
		let intervalosList = document.getElementById("intervalosList")
		intervalosList.setAttribute("hx-get", "/tareas/" + tareaID)
		htmx.process(intervalosList)
		intervalosList.dispatchEvent(new Event("cargarIntervalos"))
	}
	// Reload intervalos after swap.
	document.getElementById("tareasList").addEventListener("htmx:afterSwap", (event) => {
		if (document.getElementById("modalIntervalos").open) {
			document.getElementById('intervalosList').dispatchEvent(new Event('cargarIntervalos'));
		}
	})
</script>
{{ end }}

<!-- ======================================================== -->
{{ define "ctxMenuHistoria" -}}
<dialog id="ctxMenuHistoria{{ .HistoriaID }}" tipo="ctxMenuHistoria" class="absolute p-0 m-0 text-slate-300 bg-cyan-900 border border-slate-300 rounded-sm shadow-md"
	onclick="this.close()"
	>
	<form class="grid grid-cols-2 gap-1 p-2 text-sm">

		<div class="col-span-2 px-1 text-xs opacity-50">
			Prioridad
		</div>
		<button class="block w-full p-1 pr-2 text-left transition-colors rounded-sm hover:shadow-md hover:bg-cyan-700 {{ if .EsPrioridadMust }}font-bold{{ end }}"
			hx-post="/historias/{{ .HistoriaID }}/priorizar/3"
			type="button"
			>
			<span class="inline-block w-5 text-center">
				<i class="text-orange-600 fa-solid fa-angles-up"></i>
			</span>
			Must
		</button>
		<button class="block w-full p-1 pr-2 text-left transition-colors rounded-sm hover:shadow-md hover:bg-cyan-700 {{ if .EsPrioridadShould }}font-bold{{ end }}"
			hx-post="/historias/{{ .HistoriaID }}/priorizar/2"
			type="button"
			>
			<span class="inline-block w-5 text-center">
				<i class="text-orange-400 fa-solid fa-chevron-up"></i>
			</span>
			Should
		</button>
		<button class="block w-full p-1 pr-2 text-left transition-colors rounded-sm hover:shadow-md hover:bg-cyan-700 {{ if .EsPrioridadCould }}font-bold{{ end }}"
			hx-post="/historias/{{ .HistoriaID }}/priorizar/1"
			type="button"
			>
			<span class="inline-block w-5 text-center">
				<i class="text-orange-200 fa-solid fa-minus"></i>
			</span>
			Would
		</button>
		<button class="block w-full p-1 pr-2 text-left transition-colors rounded-sm hover:shadow-md hover:bg-cyan-700 {{ if .EsPrioridadWont }}font-bold{{ end }}"
			hx-post="/historias/{{ .HistoriaID }}/priorizar/0"
			type="button"
			>
			<span class="inline-block w-5 text-center">
				<i class="text-slate-400 fa-solid fa-ban"></i>
			</span>
			Won't
		</button>

		<div class="col-span-2 px-1 text-xs opacity-50">
			Estatus
		</div>
		<button class="block w-full p-1 pr-2 text-left transition-colors rounded-sm hover:shadow-md hover:bg-cyan-700 {{ if .Completada }}font-bold{{ end }}"
			hx-post="/historias/{{ .HistoriaID }}/marcar/1"
			type="button"
			>
			<span class="inline-block w-5 text-center">
				<i class="text-green-600 fa-solid fa-circle-check"></i>
			</span>
			Lista
		</button>
		<button class="block w-full p-1 pr-2 text-left transition-colors rounded-sm hover:shadow-md hover:bg-cyan-700 {{ if not .Completada }}font-bold{{ end }}"
			hx-post="/historias/{{ .HistoriaID }}/marcar/0"
			type="button"
			>
			<span class="inline-block w-5 text-center">
				<i class="text-orange-600 fa-regular fa-circle"></i>
			</span>
			Falta
		</button>

		<div class="col-span-2 px-1 text-xs opacity-50">
			Acciones
		</div>
		<button class="block w-full p-1 pr-2 text-left transition-colors rounded-sm hover:shadow-md hover:bg-cyan-700"
			type="button"
			onclick="showMoverHistoria('{{ .HistoriaID }}', '{{ .Titulo }}')"
			>
			<span class="inline-block w-5 text-center">
				<i class="text-cyan-500 fa-solid fa-person-walking"></i>
			</span>
			Mover
		</button>
		<button class="block w-full p-1 pr-2 text-left transition-colors rounded-sm hover:shadow-md hover:bg-cyan-700"
			hx-confirm="¬øEliminar historia? {{ .Titulo }}"
			hx-delete="/historias/{{ .HistoriaID }}"
			type="button"
			>
			<span class="inline-block w-5 text-center">
				<i class="text-red-500 fa-solid fa-trash"></i>
			</span>
			Eliminar
		</button>
	</form>
</dialog>
{{ end -}}
<script>
	document.querySelectorAll("dialog[tipo='ctxMenuHistoria']").forEach((menu) => {
		menu.addEventListener('click', (event) => menu.close());
		// menu.querySelector("div").addEventListener('click', (event) => event.stopPropagation());
	});
	
	function showMenuHistoria(historiaID) {
		menu = document.getElementById('ctxMenuHistoria' + historiaID);
		let menuW = menu.offsetWidth // Dimensiones del men√∫
		let menuH = menu.offsetHeight
		let winW = window.innerWidth // Dimensiones de la ventana
		let winH = window.innerHeight
		let x = event.clientX // Coordenadas dentro de la ventana
		let y = event.clientY
		if (x + menuW > winW) { x = winW - menuW } // Que no salga de la ventana
		if (y + menuH > winH) { y = winH - menuH }
		menu.style.left = `${x}px`
		menu.style.top = `${y}px`
		menu.showModal();
	}
</script>

<!-- ======================================================== -->
<script>
	function showMoverTramo(historiaID, posicion, descripcion) {
		let mov = document.getElementById('moverTramo');
		mov.showModal();
		mov.querySelector('input[name=historia_id]').value = historiaID;
		mov.querySelector('input[name=posicion]').value = posicion;
		mov.querySelector('p').innerText = descripcion;
		document.getElementById('navTreeTramo').dispatchEvent(new Event('navTreeTramoShown'));
		console.log(`showMoverTramo(${historiaID},${posicion})`);
	}

	function showMoverHistoria(historiaID, descripcion) {
		let mov = document.getElementById('moverHistoria');
		mov.showModal();
		mov.querySelector('input[name=historia_id]').value = historiaID;
		mov.querySelector('p').innerText = descripcion;
		document.getElementById('navTreeHistoria').dispatchEvent(new Event('navTreeHistoriaShown'));
		console.log(`showMoverHistoria(${historiaID})`);
	}

	function showAddReferencia() {
		let mov = document.getElementById('dialogAddReferencia');
		mov.showModal();
		document.getElementById('navAddReferencia').dispatchEvent(new Event('navAddReferenciaShown'));
	}
</script>

<dialog id="moverTramo" class="m-auto text-white bg-cyan-900 border-4 border-cyan-800 rounded-md">
	<header class="flex items-center gap-2 p-2 bg-cyan-800">
		<h2 class="grow text-xl">
			Mover tramo
		</h2>
		<button class="inline-block float-right px-2 text-2xl rounded-md hover:opacity-75"
			type="button"
			onclick="this.closest('dialog').close()"
			title="Cerrar"
			>
			<i class="fa-solid fa-xmark"></i>
		</button>
	</header>
	<form class="flex flex-col gap-2 p-2">
		<p class="mb-2 italic">
			Nombre de la tramo
		</p>
		<input
			type="hidden"
			name="historia_id"
			required
			>
		<input
			type="hidden"
			name="posicion"
			required
			>
		<div id="navTreeTramo" class="flex flex-col gap-1 sm:w-96"
			hx-get="/nav/hist/{{ .Agregado.Historia.HistoriaID }}"
			hx-swap="innerHTML"
			hx-target="#navTreeTramo"
			hx-trigger="navTreeTramoShown"
			>
			<!-- nav_tree -->
		</div>
		<button class="inline-block w-full px-6 py-2 font-medium text-slate-100 transition-colors bg-blue-700 rounded-sm shadow-md hover:bg-blue-600"
			hx-post="/mover/tramo"
			hx-select="main"
			hx-swap="outerHTML"
			hx-target="main"
			type="submit"
			onclick="this.closest('dialog').close()"
			>
			Mover
		</button>
	</form>
</dialog>

{{ block "mover_tarea_dialog" .Agregado.Historia.HistoriaID }}
{{/* Recibe el historia_id que ser√° origen para nav, sino inicia en root */}}
<dialog id="moverTareaDialog" class="m-auto text-white bg-cyan-900 border-4 border-cyan-800 rounded-md">
	<header class="flex items-center gap-2 p-2 bg-cyan-800">
		<h2 class="grow text-xl">
			Mover tarea
		</h2>
		<button class="inline-block float-right px-2 text-2xl rounded-md hover:opacity-75"
			type="button"
			onclick="this.closest('dialog').close()"
			title="Cerrar"
			>
			<i class="fa-solid fa-xmark"></i>
		</button>
	</header>
	<form class="flex flex-col gap-2 p-2">
		<p class="mb-2 italic">
			Nombre de la tarea
		</p>
		<input
			type="hidden"
			name="tarea_id"
			required
			>
		<div class="flex flex-col gap-1 sm:w-96"
			hx-get="/nav{{ if . }}/hist/{{ . }}{{ end }}"
			hx-swap="innerHTML"
			hx-target="this"
			hx-trigger="intersect once"
			>
			<!-- nav_tree -->
		</div>
		<button class="inline-block w-full px-6 py-2 font-medium text-slate-100 transition-colors bg-blue-700 rounded-sm shadow-md hover:bg-blue-600"
			hx-post="/mover/tarea"
			hx-select="main"
			hx-swap="outerHTML"
			hx-target="main"
			type="submit"
			onclick="this.closest('dialog').close()"
			>
			Mover
		</button>
	</form>
</dialog>
<script>
	function showMoverTarea(tareaID, descripcion) {
		let mov = document.getElementById('moverTareaDialog');
		mov.showModal();
		mov.querySelector('input[name=tarea_id]').value = tareaID;
		mov.querySelector('p').innerText = descripcion;
	}
</script>
{{ end }}

<dialog id="moverHistoria" class="m-auto text-white bg-cyan-900 border-4 border-cyan-800 rounded-md">
	<header class="flex items-center gap-2 p-2 bg-cyan-800">
		<h2 class="grow text-xl">
			Mover historia
		</h2>
		<button class="inline-block float-right px-2 text-2xl rounded-md hover:opacity-75"
			type="button"
			onclick="this.closest('dialog').close()"
			title="Cerrar"
			>
			<i class="fa-solid fa-xmark"></i>
		</button>
	</header>
	<form class="flex flex-col gap-2 p-2">
		<p class="mb-2 italic text-orange-400">
			Historia a mover
		</p>
		<input
			type="hidden"
			name="historia_id"
			required
			>
		<div id="navTreeHistoria" class="flex flex-col gap-1 sm:w-96"
			hx-get="/nav/hist/{{ .Agregado.Historia.HistoriaID }}"
			hx-swap="innerHTML"
			hx-target="#navTreeHistoria"
			hx-trigger="navTreeHistoriaShown"
			>
			<!-- nav_tree -->
		</div>
		<button class="inline-block w-full px-6 py-2 font-medium text-slate-100 transition-colors bg-blue-700 rounded-sm shadow-md hover:bg-blue-600"
			hx-post="/mover/historia"
			hx-select="main"
			hx-swap="outerHTML"
			hx-target="main"
			type="submit"
			onclick="this.closest('dialog').close()"
			>
			Mover
		</button>
	</form>
</dialog>

<dialog id="dialogAddReferencia" class="m-auto text-white bg-cyan-900 border-4 border-cyan-800 rounded-md">
	<header class="flex items-center gap-2 p-2 bg-cyan-800">
		<h2 class="grow text-xl">
			Agregar referencia a historia relacionada
		</h2>
		<button class="inline-block float-right px-2 text-2xl rounded-md hover:opacity-75"
			type="button"
			onclick="this.closest('dialog').close()"
			title="Cerrar"
			>
			<i class="fa-solid fa-xmark"></i>
		</button>
	</header>
	<form class="flex flex-col gap-2 p-2">
		<div id="navAddReferencia" class="flex flex-col gap-1 sm:w-96"
			hx-get="/nav/hist/{{ .Agregado.Historia.HistoriaID }}"
			hx-swap="innerHTML"
			hx-target="#navAddReferencia"
			hx-trigger="navAddReferenciaShown"
			>
			<!-- nav_tree -->
		</div>
		<button class="inline-block w-full px-6 py-2 font-medium text-slate-100 transition-colors bg-blue-700 rounded-sm shadow-md hover:bg-blue-600"
			hx-post="/historias/{{ .Agregado.Historia.HistoriaID }}/referencias"
			hx-select="main"
			hx-swap="outerHTML"
			hx-target="main"
			type="submit"
			onclick="this.closest('dialog').close()"
			>
			Agregar
		</button>
	</form>
</dialog>

<div id="msgStack" class="hidden">
	<!-- Mensajes respuesta del servidor -->
</div>

<!-- ======================================================== -->

<!-- VIAJE DE USUARIO -->
<script>
	// Capturar CTRL + V para subir imagen al tramo.

	function getGoogleusercontentImageUrl(htmlString) {
		if (htmlString == "") {
			throw new Error('Invalid HTML: Empty string');
		}
		const parser = new DOMParser();
		const doc = parser.parseFromString(htmlString, 'text/html');
		const imgTag = doc.querySelector('img');
		if (!imgTag) {
			throw new Error('Invalid HTML: Must contain an image tag');
		}
		const imgUrl = imgTag.getAttribute('src');
		const regex = /^https?:\/\/([a-zA-Z0-9-]+\.)*googleusercontent\.com/;
		if (!regex.test(imgUrl)) {
			throw new Error('Invalid URL: Must be an image hosted on googleusercontent.com');
		}
		return imgUrl;
	}

	async function fetchImageFromURL(imgUrl) {
		if (imgUrl == "") {
			throw new Error('fetchImageFromURL: empty url');
		}
		console.log("Fetching image:", imgUrl)
		const response = await fetch(imgUrl);
		const blob = await response.blob();
		const file = new File([blob], 'image.jpg', { type: blob.type });
		return file;
	}

	let tramoImgModal = document.getElementById("TramoImgModal");
	window.addEventListener('paste', function(event) {
		if (!tramoImgModal.open) {
			return
		}
		const imgFileInput = tramoImgModal.querySelector("input[type='file']")
		const items = (event.clipboardData || event.originalEvent.clipboardData).items

		// console.log("Pegando", tramoImgModal.open, imgFileInput)

		let isGoogleImage = false
		let isImageFile = false
		
		// Averiguar qu√© hacer.
		for (const item of items) {
			// item.getAsString(url => { console.log(`ITEM kind:${item.kind} type:${item.type}`, url) })
			if (item.type.startsWith('image/')) {
				isImageFile = true

			} else if (item.type === 'application/x-vnd.google-docs-image-clip+wrapped') {
				isGoogleImage = true
			}
		}

		if (isImageFile) {
			// TODO: solo aceptar un archivo y que sea imagen.
			imgFileInput.files = event.clipboardData.files
			imgFileInput.dispatchEvent(new Event('change'));

		} else if (isGoogleImage) {
			for (const item of items) {
				if (item.type === 'text/html') {
					item.getAsString(htmlString => {
						// Todo se hace aqu√≠ adentro porque getAsString es async y hay que esperarla.
						try {
							const imgUrl = getGoogleusercontentImageUrl(htmlString)
							fetchImageFromURL(imgUrl).then(file => {
								const dataTransfer = new DataTransfer();
								dataTransfer.items.add(file);
								imgFileInput.files = dataTransfer.files;
								imgFileInput.dispatchEvent(new Event('change'));
							});
						} catch (error) {
							console.error(error)
						}

					})
				}
			}
		}

	})

	function showTramoImgModal(liElement) {
		// Obtener datos del tramo seleccionado.
		let historiaID= liElement.querySelector("input[name='historia_id']").value
		let posicion =	liElement.querySelector("input[name='old_pos']").value
		let texto = 	liElement.querySelector("textarea").value
		let imgElem = 	liElement.querySelector("img")
		let imgSrc = 	imgElem ? imgElem.src : ""
		
		// Poner datos en el dialog.
		let dialog = document.getElementById("TramoImgModal")
		let btnEliminarImg = dialog.querySelector("button[tipo='eliminar_img']")
		dialog.querySelector("h2").textContent = `Viaje de usuario (${posicion})`
		dialog.querySelector("p").textContent = texto
		dialog.querySelector("input[name='historia_id']").value = historiaID
		dialog.querySelector("input[name='posicion']").value = posicion
		dialog.querySelector("input[type='file']").value = ""
		dialog.querySelector("button[type='submit']").textContent = imgSrc ? "Remplazar" : "Subir imagen"
		if (imgSrc != "") {
			dialog.querySelector("img").src = imgSrc
			dialog.querySelector("img").classList.remove("hidden")
			btnEliminarImg.setAttribute("hx-delete", "/imagenes/" + historiaID + "/" + posicion)
			btnEliminarImg.classList.remove("hidden")
			dialog.querySelector("button[tipo='cancelar']").classList.add('hidden')
		} else {
			dialog.querySelector("img").src = ""
			dialog.querySelector("img").classList.add("hidden")
			btnEliminarImg.removeAttribute("hx-delete")
			btnEliminarImg.classList.add("hidden")
			dialog.querySelector("button[tipo='cancelar']").classList.remove('hidden')
		}
		htmx.process(btnEliminarImg)
		
		// Bot√≥n para ir a tramo anterior
		prevTramo = liElement.previousElementSibling
		let btnPrev = dialog.querySelector("button[title='Anterior']")
		if (prevTramo && prevTramo.hasAttribute('tipo') && prevTramo.getAttribute('tipo') === 'sort_tramo') {
			btnPrev.classList.remove('hidden');
			btnPrev.onclick = function() { showTramoImgModal(prevTramo); }
			dialog.addEventListener('keydown', showPrevTramoHdlrKey);
		} else {
			btnPrev.classList.add('hidden');
			btnPrev.onclick = function() { console.log("imposible") }
			dialog.removeEventListener('keydown', showPrevTramoHdlrKey);
		}
		// Bot√≥n para ir a tramo siguiente
		nextTramo = liElement.nextElementSibling
		let btnNext = dialog.querySelector("button[title='Siguiente']")
		if (nextTramo && nextTramo.hasAttribute('tipo') && nextTramo.getAttribute('tipo') === 'sort_tramo') {
			btnNext.classList.remove('hidden');
			btnNext.onclick = function() { showTramoImgModal(nextTramo); }
			dialog.addEventListener('keydown', showNextTramoHdlrKey);
		} else {
			btnNext.classList.add('hidden');
			btnNext.onclick = function() { console.log("imposible") }
			dialog.removeEventListener('keydown', showNextTramoHdlrKey);
		}
		// Mostrar dialog antes de hacer focus.
		dialog.showModal()
		dialog.querySelector("button[title='Cerrar']").focus()
	}
	// Handlers como funciones utilizando globales para poder removerlos.
	function showPrevTramoHdlrKey(event) {
		if (event.key === 'ArrowLeft') { showTramoImgModal(prevTramo); }
	}
	function showNextTramoHdlrKey(event) {
		if (event.key === 'ArrowRight') { showTramoImgModal(nextTramo); }
	}
	let prevTramo = null
	let nextTramo = null
	
	// Mostrar imagen cuando se selecciona un archivo.		
	function showTramoImagePreview() {
		let dialog = document.getElementById("TramoImgModal")
		const [file] = dialog.querySelector("input[type='file']").files
		if (file) {
			// console.log('Archivo: ' + file.name);
			dialog.querySelector("img").src = URL.createObjectURL(file)
			dialog.querySelector("img").classList.remove("hidden")
			dialog.querySelector("button[tipo='eliminar_img']").classList.add('hidden')
			dialog.querySelector("button[tipo='cancelar']").classList.remove("hidden")
			dialog.querySelector("button[type='submit']").focus()
		}
	}
</script>

<script>	
	// Recargar historia cuando se recibe la respuesta del servidor en msgStack.
	document.getElementById("msgStack").addEventListener("htmx:afterSwap", (event) => {
		document.querySelector("main").dispatchEvent(new Event("reloadHistoria"));
	})
	
	function handleResponse(response) {
		response.text().then((msg) => {
			if (response.status >= 200 && response.status < 300) {
				console.log(msg)
			} else {
				alert(msg)
			}
			document.querySelector("main").dispatchEvent(new Event("reloadHistoria"))
		})
	}

	let historiaID = {{ .Agregado.Historia.HistoriaID }};

	// ================================================================ //
	// ========== WEBSOCKET =========================================== //

	var uri = 'ws:'; if (window.location.protocol === 'https:') { uri = 'wss:'; }; uri += '//' + window.location.host + '/historias/{{ .Agregado.Historia.HistoriaID }}/ws';
	const ws = new WebSocket(uri)
	let wsID = 0
	ws.onopen = function() {
		// console.log('Connected to ' + uri);
	}
	ws.onclose = function(event) {
		console.log("WebSocket closed:", event);
	};
	ws.onerror = function(error) {
		console.log("WebSocket error:", error);
	};
	ws.onmessage = function(event) {
		let data = JSON.parse(event.data)
		if (data.id > 0 && wsID == 0) {
			wsID = data.id
			// console.log("WebsocketID: " + wsID)

		} else if (data.reload) {
			document.querySelector("main").dispatchEvent(new Event("reloadHistoria"))
			// console.log("Recargar historia")
			
		} else {
			// console.log("Mensaje recibido: ", data)
		}
	};
	// Send wsID with non GET requests
	document.body.addEventListener('htmx:configRequest', function(event) {
		if (event.detail.verb != 'get'){
			event.detail.headers['X-SocketID'] = wsID;
			// console.log("Send wsID: " + wsID + " " + event.detail.verb)
		}
	});

	// ================================================================ //
	// ================================================================ //
	document.body.addEventListener('htmx:load', (event) => {
		console.log("htmx:load", performance.now(), event.detail.elt);

		// initContextMenu(content);

		// Reordenar tramos
		var sortableTramos = new Sortable(document.querySelector("[tipo='sort_tramos']"), {
			group: "sort_tramos", animation: 150, swapThreshold: 0.50,
			draggable: "[tipo='sort_tramo']",
			handle: "[tipo='sort_handle']",
			ghostClass: "opacity-50",
			onEnd: function (event) {
				if (event.oldIndex == event.newIndex){ return }
				event.item.querySelector("input[name='new_pos']").value = event.newIndex + 1;
				event.item.querySelector("form[tipo='sort_form']").dispatchEvent(new Event("reordenarEnd"));
          	},
		});

		// Reordenar reglas
		var sortableReglas = new Sortable(document.querySelector("[tipo='sort_reglas']"), {
			group: "sort_reglas", animation: 150, swapThreshold: 0.50,
			draggable: "[tipo='sort_regla']",
			handle: "[tipo='sort_handle']",
			ghostClass: "opacity-50",
			onEnd: function (event) {
				if (event.oldIndex == event.newIndex){ return }
				event.item.querySelector("input[name='new_pos']").value = event.newIndex + 1;
				event.item.querySelector("form[tipo='sort_form']").dispatchEvent(new Event("reordenarEnd"));
          	},
		});

		// Reordenar descendientes
		var sortableDescend = new Sortable(document.querySelector("[tipo='sort_descendientes']"), {
			group: "sort_descendientes", animation: 150, swapThreshold: 0.50,
			draggable: "[tipo='sort_descendiente']",
			handle: "[tipo='sort_handle']",
			ghostClass: "opacity-50",
			onEnd: function (event) {
				if (event.oldIndex == event.newIndex){ return }
				event.item.querySelector("input[name='new_pos']").value = event.newIndex + 1;
				event.item.querySelector("form[tipo='sort_form']").dispatchEvent(new Event("reordenarEnd"));
          	},
		});


		// Ubicar una elemento seleccionada mediante el URL fragment.
		if (window.location.hash) {
			let elemento = document.getElementById(window.location.hash.substr(1));
			if (elemento != null) {
				elemento.classList.add("border-indigo-600");
				elemento.classList.add("border-2");
				elemento.scrollIntoView();
			}
		}

		// Para poder pegar imagen para el tramo.
		tramoImgModal = document.getElementById("TramoImgModal");

	});
</script>


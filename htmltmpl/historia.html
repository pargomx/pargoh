{{ with .Agregado -}}
<header class="relative flex w-full mb-4 bg-cyan-950 shadow-lg">
	<div class="p-2">
		<img src="{{ if .Proyecto.Imagen }}/imagenes/{{ .Proyecto.Imagen }}{{ else }}/assets/img/pargo_96.png{{ end }}" alt="Portada del proyecto" class="w-24 h-24">
	</div>
	<div class="w-full p-2">
		<h2 class="text-2xl font-medium">
			<a href="/proyectos/{{ .Proyecto.ProyectoID }}">
				{{ .Proyecto.Titulo }}
			</a>
		</h2>
		<h3 class="flex items-center gap-1 py-1">
			<span class="px-2 py-1 font-mono text-sm bg-black bg-opacity-40 rounded-md"><i class="fa-solid fa-person"></i></span>
			<a href="/personas/{{ .Persona.PersonaID }}" class="text-xl">{{ .Persona.Nombre }}</a>
		</h3>
		<p class="opacity-50">
			{{ .Persona.Descripcion }}
		</p>
	</div>
	<span class="absolute right-2 top-2">
		<a href="/" class="px-2 py-1 bg-red-800 rounded-md opacity-75 hover:opacity-100"><i class="fa-solid fa-xmark"></i></a>
	</span>
</header>

<main class="flex-grow w-full max-w-5xl mx-auto">
	<h4 class="mb-2">
		<span class="opacity-50">Como</span>
		<span class="text-lg lowercase">{{ .Persona.Nombre }}</span>
		<span class="opacity-50">quiero...</span>
	</h4>

	{{ with .Historia }}
	<div class="flex items-end gap-4 mb-4">
		<div class="grow">
			<input hx-patch="/historias/{{ .HistoriaID }}/titulo" hx-swap="none" name="value" hx-trigger="keyup changed delay:2s" id="txt_hist_nombre" type="text" value="{{ .Titulo }}" class="w-full px-2 py-1 text-2xl font-medium text-white bg-transparent border-b border-cyan-800 outline-none focus:border-blue-400">
		</div>
		<div>
			<select hx-patch="/historias/{{ .HistoriaID }}/prioridad" hx-swap="none" name="value" id="txt_hist_prioridad" class="form-control">
				<option value="0" {{ if eq .Prioridad 0 }}selected{{ end }}>ğŸš« Won't</option>
				<option value="1" {{ if eq .Prioridad 1 }}selected{{ end }}>ğŸ˜¶â€ğŸŒ«ï¸ Could</option>
				<option value="2" {{ if eq .Prioridad 2 }}selected{{ end }}>ğŸ¤” Should</option>
				<option value="3" {{ if eq .Prioridad 3 }}selected{{ end }}>ğŸ¤© Must</option>
			</select>
		</div>
		<div>
			<select hx-patch="/historias/{{ .HistoriaID }}/completada" hx-swap="none" name="value" class="form-control" id="txt_hist_estatus">
				<option value="0">Pendiente</option>
				<option value="1" {{ if .Completada }}selected{{ end }}>âœ… Completada</option>
			</select>
		</div>
	</div>

	<div class="mb-4">
		<textarea hx-patch="/historias/{{ .HistoriaID }}/objetivo" hx-swap="none" name="value" hx-trigger="keyup changed delay:2s" id="txt_hist_empatia" cols="30" rows="1" placeholder="DescripciÃ³n del contexto..." 
			class="w-full px-2 py-1 text-base font-medium bg-transparent border-b border-cyan-800 outline-none max-h-96 focus:border-blue-400 placeholder:text-slate-600"
		>{{ .Objetivo }}</textarea>
	</div>
	{{ end }}

	<!--* VIAJE DE USUARIO *-->
	<h3 class="mb-2 text-xl text-cyan-600">Viaje de usuario</h3>
	<ol class="mb-6">
		{{ range .Tramos -}}
		<li class="p-1">
			<span tipo="carril_handle" class="px-2 py-1 mr-1 font-mono text-xs bg-black bg-opacity-40 rounded-md opacity-50 cursor-pointer whitespace-nowrap">â£¿ {{ .Posicion }}</span>
			{{ .Texto }}
			<button type="button" hx-confirm="Â¿Eliminar tramo de viaje? {{ .Texto }}" hx-delete="/historias/{{ .HistoriaID }}/viaje/{{ .Posicion }}" title="Quitar este tramo" class="float-right opacity-10 hover:opacity-100">âŒ</button>
			<button type="button" onclick="showSubirImagen({{ .HistoriaID }}, {{ .Posicion }})" title="Definir imagen" class="float-right mr-3 opacity-10 hover:opacity-100">ğŸ</button>
		</li>
		{{ end }}
		<li class="flex items-center p-1">
			<span tipo="carril_handle" class="px-2 py-1 mr-1 font-mono text-xs bg-black bg-opacity-40 rounded-md opacity-50 cursor-pointer whitespace-nowrap">â£¿ {{ suma (len .Tramos) 1 }}</span>
			<input type="text" name="texto" hx-post="/historias/{{ .Historia.HistoriaID }}/viaje" placeholder="Agregar un tramo al viaje" class="inline-block w-full px-2 py-1 text-white bg-transparent border-b border-cyan-800 outline-none placeholder:text-slate-600 focus:border-blue-400">
		</li>
	</ol>
	<div class="flex flex-wrap items-start gap-4 mb-6">
		{{ range .Tramos }}{{ if .Imagen -}}
		<div>
			<div class="relative">
				<div class="absolute flex items-center justify-center w-full h-full gap-3 rounded-md opacity-5 hover:opacity-100 bg-black/60">
					<a href="/imagenes/{{ .Imagen }}" class="">ğŸ</a>
					<button type="button" hx-delete="/imagenes/{{ .HistoriaID }}/{{ .Posicion }}" title="Eliminar imagen" hx-confirm="Â¿Eliminar esta imagen?" class="">âŒ</button>
				</div>
				<img src="/imagenes/{{ .Imagen }}" class="max-w-xs rounded-md max-h-96">
			</div>
			<p class="text-sm italic text-center opacity-50">{{ .Posicion }}. {{ .Texto }}</p>
		</div>
		{{ end }}{{ end }}
	</div>

	<!--* ANCESTROS *-->
	{{ if .Ancestros }}
	<h3 class="mb-2 text-xl text-cyan-600">Ancestros</h3>
	{{ range .Ancestros }}
	<ul class="pl-6 list-[revert]">
		<li class="p-1">
			{{ .Titulo }}
			<a href="/historias/{{ .HistoriaID }}" class="float-right opacity-10 hover:opacity-100">ğŸ‘ï¸</a>
			{{ end }}
			{{ range .Ancestros -}}
		</li>
	</ul>
	{{ end }}
	{{ end }}

	<!--* DESCENDIENTES *-->
	<h3 class="mb-2 text-xl text-cyan-600">Descendientes</h3>
	<ul class="mb-6 pl-6 list-[revert]">
		{{ range .Descendientes }}
		<li class="p-1">
			{{ .Historia.Titulo }}
			<a href="/historias/{{ .Historia.HistoriaID }}" class="float-right opacity-10 hover:opacity-100">ğŸ‘ï¸</a>

			<ul class="pl-5 list-[revert]">
				{{ range .Descendientes }}
				<li class="p-1">
					{{ .Historia.Titulo }}
				</li>
				{{ end }}
			</ul>
		</li>
		{{ end }}
		<li class="">
			<input name="titulo" type="text" hx-target="#msgStack" hx-post="/historias/{{ .Historia.HistoriaID }}" placeholder="Agregar historia" class="w-full px-2 py-1 text-white bg-transparent border-b border-cyan-800 outline-none focus:border-blue-400 placeholder:text-slate-600">
		</li>
	</ul>


	<h3 class="mb-2 text-xl text-cyan-600">Tareas de desarrollo</h3>
	<ol class="mb-6">
		{{ range .Tareas }}
		<li class="p-1">
			<span tipo="carril_handle" class="px-2 py-1 mr-1 font-mono text-xs bg-black bg-opacity-40 rounded-md opacity-50 cursor-pointer whitespace-nowrap">â£¿</span>
			<span class="inline-block w-6 text-center">
				{{ if .Finalizada }}âœ…{{ else if .EnCurso }}â³{{ else if .EnPausa }}â±{{ else }}â–¢{{ end }}
			</span>
			{{ .Descripcion }}
		</li>
		{{ end }}
		<li class="flex items-center p-1">
			<span tipo="carril_handle" class="px-2 py-1 mr-1 font-mono text-xs bg-black bg-opacity-40 rounded-md opacity-50 cursor-pointer whitespace-nowrap">â£¿</span>
			<input type="text" name="descripcion" hx-post="/historias/{{ .Historia.HistoriaID }}/tareas" placeholder="Agregar tarea" class="inline-block w-full px-2 py-1 text-white bg-transparent border-b border-cyan-800 outline-none placeholder:text-slate-600 focus:border-blue-400">
		</li>
	</ol>

</main>
{{ end }}

<div id="ctxMenu" tipo="ctxMenu" gk-historia="" class="absolute hidden p-2 text-black bg-cyan-50 rounded shadow-md">
	<div class="grid grid-cols-2 gap-1 text-sm">
		<div class="col-span-2 text-xs opacity-50">Acciones</div>
		<button type="button" onclick="expandirHistoria()" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">âœ‚ï¸ Abrir</button>
		<button type="button" onclick="editarHistoria()" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">âœï¸ Editar</button>
		<button type="button" onclick="moverHistoria()" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">ğŸš™ Mover</button>
		<button type="button" onclick="tareasHistoria()" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">ğŸ“‹ Tareas</button>
		<div class="col-span-2 text-xs opacity-50">Prioridad</div>
		<button type="button" onclick="priorizarHistoria(3)" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">ğŸ¤© Must</button>
		<button type="button" onclick="priorizarHistoria(2)" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">ğŸ¤” Should</button>
		<button type="button" onclick="priorizarHistoria(1)" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">ğŸ˜¶â€ğŸŒ«ï¸ Would</button>
		<button type="button" onclick="priorizarHistoria(0)" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">ğŸš« Won't</button>
		<div class="col-span-2 text-xs opacity-50">Estatus</div>
		<button type="button" onclick="marcarHistoria(1)" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">âœ… Okey</button>
		<button type="button" onclick="marcarHistoria(0)" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">ğŸ”» Falta</button>
		<button type="button" onclick="eliminarHistoria()" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">âŒ Eliminar</button>
	</div>
</div>

<dialog id="dialogHistoria" class="p-3 rounded-lg" hx-swap="innerHTML" hx-get="" hx-trigger="loadHistoriaForm" hx-target="this">
	<header class="flex flex-wrap items-center gap-3 pb-2">
		<h2 class="flex-grow w-full text-xl text-center sm:w-auto sm:text-left">Modificar</h2>
		<button type="button" class="w-10 py-1 text-xl text-slate-200 bg-slate-600 rounded-lg" onclick="this.parentNode.parentNode.close()" title="Cerrar"><i class="fa-solid fa-xmark"></i></button>
	</header>
	<div>
		Cargando...
	</div>
</dialog>

<dialog id="subirImagen" class="p-3 rounded-lg">
	<header class="flex flex-wrap items-center gap-3 pb-2">
		<h2 class="flex-grow w-full text-xl text-center sm:w-auto sm:text-left">Subir imagen</h2>
		<button type="button" class="w-10 py-1 text-xl text-slate-200 bg-slate-600 rounded-lg" onclick="this.parentNode.parentNode.close()" title="Cerrar"><i class="fa-solid fa-xmark"></i></button>
	</header>
	<form class="mb-4">
		<p class="text-center">
			Subir captura de pantalla para este tramo del viaje de usuario.
		</p>
		<img id="imagePreview" src="" class="hidden object-cover mx-auto my-4 rounded-lg shadow-lg aspect-square w-60">
		<div class="py-4 text-center">
			<input id="imgInputFile" type="file" name="imagen" accept="image/png, image/jpeg" capture="user" required onchange="showImagen(this)">
		</div>
		<input type="hidden" name="historia_id">
		<input type="hidden" name="posicion">
		<div id="botonesGuardarFoto" class="flex-wrap justify-center hidden gap-4 pt-4">
			<button onclick="subirImagen.close()" class="inline-block px-6 py-2 font-medium text-slate-100 transition-colors bg-gray-600 rounded shadow-md hover:bg-gray-500">Cancelar</button>
			<button id="btnSubirImagen" type="button" hx-post="/imagenes" hx-encoding="multipart/form-data" class="inline-block px-6 py-2 font-medium text-slate-100 transition-colors bg-blue-700 rounded shadow-md hover:bg-blue-600">Guardar</button>
		</div>
	</form>
	<script>
		function showSubirImagen(historiaID, posicion){
			let setImagen = document.getElementById("subirImagen")
			setImagen.querySelector("input[name='historia_id']").value = historiaID
			setImagen.querySelector("input[name='posicion']").value = posicion
			setImagen.showModal()
		}
		function showImagen() {
			const [file] = document.getElementById("imgInputFile").files
			if (file) {
				console.log('Archivo: ' + file.name);
				document.getElementById("botonesGuardarFoto").classList.remove("hidden")
				document.getElementById("botonesGuardarFoto").classList.add("flex")
				document.getElementById("imagePreview").classList.remove("hidden")
				document.getElementById("imagePreview").classList.add("block")
				document.getElementById("imagePreview").src = URL.createObjectURL(file)
			}
		}
	</script>
</dialog>

<div id="msgStack" class="hidden">
	<!-- Mensajes respuesta del servidor -->
</div>

<!-- ======================================================== -->
<script src="/assets/js/Sortable.min.js"></script>

<script>

	function expandirHistoria() {
		let historiaID = document.querySelector("[tipo='ctxMenu']").getAttribute("gk-historia")
		window.location.href = `/tablero/${historiaID}`
	}

	function tareasHistoria() {
		let historiaID = document.querySelector("[tipo='ctxMenu']").getAttribute("gk-historia")
		window.location.href = `/historias/${historiaID}`
	}

	function moverHistoria() {
		let historiaID = document.querySelector("[tipo='ctxMenu']").getAttribute("gk-historia")
		window.location.href = `/historias/${historiaID}/mover`
	}

	function editarHistoria() {
		let historiaID = document.querySelector("[tipo='ctxMenu']").getAttribute("gk-historia")
		let dialog = document.getElementById("dialogHistoria")
		dialog.showModal()
		dialog.setAttribute("hx-get", `/historias/${historiaID}/form`)
		htmx.process(dialog)
		dialog.dispatchEvent(new Event("loadHistoriaForm"))
	}

	function priorizarHistoria(prioridad) {
		if (isNaN(prioridad)) {
			alert("La prioridad debe ser un nÃºmero")
			return console.error("La prioridad debe ser un nÃºmero")
		}
		let historiaID = document.querySelector("[tipo='ctxMenu']").getAttribute("gk-historia")
		let formData = new FormData();
		formData.append("prioridad", prioridad);
		fetch(`/historias/${historiaID}/priorizar`, { method: 'POST', body: formData }).then(response => handleResponse(response));
	}
	
	function marcarHistoria(completada) {
		let historiaID = document.querySelector("[tipo='ctxMenu']").getAttribute("gk-historia")
		let formData = new FormData();
		formData.append("completada", completada);
		fetch(`/historias/${historiaID}/marcar`, { method: 'POST', body: formData }).then(response => handleResponse(response));
	}

	function eliminarHistoria() {
		let historiaID = document.querySelector("[tipo='ctxMenu']").getAttribute("gk-historia")
		let formData = new FormData();
		fetch(`/historias/${historiaID}`, { method: 'DELETE' }).then(response => handleResponse(response));
	}

	// ================================================================ //
	// ========== Context menu ======================================== //

	function setupMenuContextual(element, historiaID) {
		element.addEventListener("contextmenu", function(event) {
			event.preventDefault()
			let menu = document.querySelector("[tipo='ctxMenu']")
			menu.classList.remove("hidden")
			let menuW = menu.offsetWidth // Dimensiones del menÃº
			let menuH = menu.offsetHeight
			let winW = window.innerWidth // Dimensiones de la ventana
			let winH = window.innerHeight
			let x = event.clientX // Coordenadas dentro de la ventana
			let y = event.clientY
			if (x + menuW > winW) { x = winW - menuW } // Que no salga de la ventana
			if (y + menuH > winH) { y = winH - menuH }
			menu.style.left = `${x}px`
			menu.style.top = `${y}px`

			menu.setAttribute("gk-historia", historiaID)
		})
	}

	function inicializarCarriles() {
		document.querySelectorAll("[tipo='carril']").forEach(element => {
			setupMenuContextual(element, element.id)
		});
	}

	document.addEventListener("click", function(event) {
		let menu = document.querySelector("[tipo='ctxMenu']")
		if (menu.classList.contains("hidden")) { return }
		menu.classList.add("hidden")
	})

	// ================================================================ //
	// ========== Inicializar ========================================= //
	
	inicializarCarriles()

	// Cada vez que cambie el contenido hay que volver a inicializar los carriles.
	document.querySelector("[tipo='carriles_container']").addEventListener("htmx:afterSwap", (event) => {
		inicializarCarriles()
	})

	document.getElementById("msgStack").addEventListener("htmx:afterSwap", (event) => {
		document.querySelector("[tipo='carriles_container']").dispatchEvent(new Event("historiasActualizadas"))
		dialogHistoria.close()
	})



	// ================================================================ //
	// ========== Reordenar =========================================== //

	function reordenarHistoria(historiaID, newPosicion) {
		console.debug(`reordenarHistoria(id:${historiaID}, pos:${newPosicion})`)
		if (historiaID == null) {
			return console.error("No se puede reordenar persona sin ID")
		}
		let formData = new FormData();
		formData.append("newPosicion", newPosicion);
		fetch(`/nodos/${historiaID}/reordenar`, { method: 'POST', body: formData }).then(response => handleResponse(response));
	}

	function handleResponse(response) {
		response.text().then((msg) => {
			if (response.status >= 200 && response.status < 300) {
				console.log(msg)
			} else {
				alert(msg)
			}
			// Recargar carriles con HTMX
			document.querySelector("[tipo='carriles_container']").dispatchEvent(new Event("historiasActualizadas"))
		})
	}
	
	var zonaCarriles = new Sortable(document.querySelector("[tipo='carriles_container']"), {
		group: "carriles", animation: 150, swapThreshold: 0.50,
		draggable: "[tipo='carril']",
		handle: "[tipo='carril_handle']",
		onStart: function(event) {
			event.item.classList.add("opacity-50")
		},
		onEnd: function(event) {
			event.item.classList.remove("opacity-50")
			let historiaID = event.item.id
			if (historiaID == null) { 
				return console.error("historiaID null") 
			}
			if (event.oldIndex != event.newIndex){
				return reordenarHistoria(historiaID, event.newIndex + 1)
			}
		},
	});

	// Ubicar una historia seleccionada mediante el URL fragment.
	if (window.location.hash) {
		let historia = document.getElementById(window.location.hash.substr(1));
		if (historia != null) {
			historia.classList.add("border-indigo-600");
			historia.classList.add("border-2");
			historia.scrollIntoView();
		}
	}

</script>
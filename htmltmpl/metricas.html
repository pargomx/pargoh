<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<h3 class="mt-4 text-xl text-cyan-600 text-center">
	Tiempo trabajado: últimos 7 días
</h3>
<div class="flex grow items-center justify-center p-4">
	<div class="p-2 bg-cyan-700 rounded-md">
		<svg xmlns="http://www.w3.org/2000/svg" width="480" height="810" class="w-full">
			<!-- Background -->
			<rect x="0" y="0" width="480" height="810" fill="white" />

			<!-- Horizontal grid lines (time slots) -->
			<g stroke="lightgray" stroke-width="1">
				<line id="lh_0" x1="0" y1="000" x2="480" y2="000" />
				<line id="lh_1" x1="0" y1="090" x2="480" y2="090" />
				<line id="lh_2" x1="0" y1="180" x2="480" y2="180" />
				<line id="lh_3" x1="0" y1="270" x2="480" y2="270" />
				<line id="lh_4" x1="0" y1="360" x2="480" y2="360" />
				<line id="lh_5" x1="0" y1="450" x2="480" y2="450" />
				<line id="lh_6" x1="0" y1="540" x2="480" y2="540" />
				<line id="lh_7" x1="0" y1="630" x2="480" y2="630" />
				<line id="lh_8" x1="0" y1="720" x2="480" y2="720" />
				<line id="lh_9" x1="0" y1="810" x2="480" y2="810" />
			</g>

			<!-- Vertical grid lines (days) -->
			<g stroke="gray" stroke-width="1">
				<line id="lv_1" x1="000" y1="0" x2="000" y2="810" />
				<line id="lv_1" x1="060" y1="0" x2="060" y2="810" />
				<line id="lv_2" x1="120" y1="0" x2="120" y2="810" />
				<line id="lv_3" x1="180" y1="0" x2="180" y2="810" />
				<line id="lv_4" x1="240" y1="0" x2="240" y2="810" />
				<line id="lv_5" x1="300" y1="0" x2="300" y2="810" />
				<line id="lv_6" x1="360" y1="0" x2="360" y2="810" />
				<line id="lv_7" x1="420" y1="0" x2="420" y2="810" />
				<line id="lv_8" x1="480" y1="0" x2="480" y2="810" />
			</g>

			<!-- Day Labels -->
			{{ if .Semana }}
			<text id="dia_1" x="090" y="60" font-size="12" text-anchor="middle">{{ (index .Semana 0).GetFechaAbrev }}</text>
			<text id="dia_2" x="150" y="60" font-size="12" text-anchor="middle">{{ (index .Semana 1).GetFechaAbrev }}</text>
			<text id="dia_3" x="210" y="60" font-size="12" text-anchor="middle">{{ (index .Semana 2).GetFechaAbrev }}</text>
			<text id="dia_4" x="270" y="60" font-size="12" text-anchor="middle">{{ (index .Semana 3).GetFechaAbrev }}</text>
			<text id="dia_5" x="330" y="60" font-size="12" text-anchor="middle">{{ (index .Semana 4).GetFechaAbrev }}</text>
			<text id="dia_6" x="390" y="60" font-size="12" text-anchor="middle">{{ (index .Semana 5).GetFechaAbrev }}</text>
			<text id="dia_7" x="450" y="60" font-size="12" text-anchor="middle">{{ (index .Semana 6).GetFechaAbrev }}</text>
			
			<text id="dia_1" x="090" y="42" font-size="18" text-anchor="middle">{{ (index .Semana 0).GetDiaSemanaAbrev }}</text>
			<text id="dia_2" x="150" y="42" font-size="18" text-anchor="middle">{{ (index .Semana 1).GetDiaSemanaAbrev }}</text>
			<text id="dia_3" x="210" y="42" font-size="18" text-anchor="middle">{{ (index .Semana 2).GetDiaSemanaAbrev }}</text>
			<text id="dia_4" x="270" y="42" font-size="18" text-anchor="middle">{{ (index .Semana 3).GetDiaSemanaAbrev }}</text>
			<text id="dia_5" x="330" y="42" font-size="18" text-anchor="middle">{{ (index .Semana 4).GetDiaSemanaAbrev }}</text>
			<text id="dia_6" x="390" y="42" font-size="18" text-anchor="middle">{{ (index .Semana 5).GetDiaSemanaAbrev }}</text>
			<text id="dia_7" x="450" y="42" font-size="18" text-anchor="middle">{{ (index .Semana 6).GetDiaSemanaAbrev }}</text>
			{{ else }}
			<text id="dia_1" x="090" y="22" font-size="18" text-anchor="middle">Lun</text>
			<text id="dia_2" x="150" y="22" font-size="18" text-anchor="middle">Mar</text>
			<text id="dia_3" x="210" y="22" font-size="18" text-anchor="middle">Mié</text>
			<text id="dia_4" x="270" y="22" font-size="18" text-anchor="middle">Jue</text>
			<text id="dia_5" x="330" y="22" font-size="18" text-anchor="middle">Vie</text>
			<text id="dia_6" x="390" y="22" font-size="18" text-anchor="middle">Sáb</text>
			<text id="dia_7" x="450" y="22" font-size="18" text-anchor="middle">Dom</text>
			{{ end }}


			<!-- Time Labels -->
			<text id="hra_1" x="30" y="086" font-size="12" text-anchor="middle">06:00am</text>
			<text id="hra_2" x="30" y="176" font-size="12" text-anchor="middle">09:00am</text>
			<text id="hra_3" x="30" y="266" font-size="12" text-anchor="middle">12:00pm</text>
			<text id="hra_4" x="30" y="356" font-size="12" text-anchor="middle">03:00pm</text>
			<text id="hra_5" x="30" y="446" font-size="12" text-anchor="middle">06:00pm</text>
			<text id="hra_6" x="30" y="536" font-size="12" text-anchor="middle">09:00pm</text>
			<text id="hra_7" x="30" y="626" font-size="12" text-anchor="middle">12:00am</text>
			<text id="hra_8" x="30" y="716" font-size="12" text-anchor="middle">03:00am</text>
			<text id="hra_9" x="30" y="806" font-size="12" text-anchor="middle">06:00am</text>

			<!-- Intervalos -->
			{{ range $diaIdx, $sem := .Semana -}}
			{{ $diaNum := suma $diaIdx 1 -}}
			{{ range .Proyectos -}}
			{{ range .Historias -}}
			{{ range .Tareas -}}
			{{ range .Intervalos -}}
			<rect x="{{ suma (mult $diaNum 60) 4 }}" y="{{ div .MinutosSince6am 2 }}" width="52" height="{{ div .Segundos 120 }}" fill="orange"></rect>
			{{ end -}}
			{{ end -}}
			{{ end -}}
			{{ end -}}
			{{ end }}
		</svg>
	</div>
</div>

{{/* 
<!-- DEBUG INTERVALOS EN GRÁFICO SEMANAL -->
<table class="font-mono text-right">
	<thead>
		<th>Fecha</th>
		<th>Inicio</th>
		<th>Fin</th>
		<th>Start min</th>
		<th>Start px</th>
		<th>Dur seg</th>
		<th>Dur px</th>
	</thead>
	<tbody>
	{{ range .Semana }}
	{{ range .Proyectos }}
	{{ range .Historias }}
	{{ range .Tareas }}
	{{ range .Intervalos }}
	<tr>
		<td>
			{{ .Fecha }}
		</td>
		<td>
			{{ .Inicio }}
		</td>
		<td>
			{{ .Fin }}
		</td>
		<td>
			{{ .MinutosSince6am }}
		</td>
		<td>
			{{ div .MinutosSince6am 2 }}
		</td>
		<td>
			{{ .Segundos }}
		</td>
		<td>
			{{ div .Segundos 120 }}
		</td>
	</tr>
	{{ end }}
	{{ end }}
	{{ end }}
	{{ end }}
	{{ end }}
	</tbody>
</table>
*/}}

<main class="grow w-full p-2">

	<!--? DIAS DE TRABAJO -->
	{{ if .DiasTrabajo -}}
	<h3 class="mt-4 mb-4 text-xl text-cyan-600">
		Tiempo invertido: Días en general
	</h3>
	<p>
		{{ with .PersonaCosto -}}
		Estimado total: {{ .SegundosEstimado }} <br>
		Invertido total: {{ .SegundosUtilizado }}
		{{ end }}
	</p>
	<div class="p-4 mb-4">
		<canvas id="chartDiasTrabajoOld"></canvas>
	</div>
	<script>
		new Chart(document.getElementById('chartDiasTrabajoOld'), {
			type: 'bar',
			data: {
				labels: [{{ range .DiasTrabajo }}'{{ .Fecha }}',{{ end }}],
				datasets: [
					{
						label: 'Horas2',
						data: [{{ range .DiasTrabajo }}{{ .Horas }},{{ end }}],
					},
				]
			},
		});
	</script>
	{{ end }}

	<!--? DIAS DE TRABAJO OLD -->
	{{ if .DiasTrabajoMapHoras -}}
	<h3 class="mt-4 mb-4 text-xl text-cyan-600">
		Tiempo invertido: Días con horas de trabajo
	</h3>
	<p>
		{{ with .PersonaCosto -}}
		Estimado total: {{ .SegundosEstimado }} <br>
		Invertido total: {{ .SegundosUtilizado }}
		{{ end }}
	</p>
	<div class="p-4 mb-4">
		<canvas id="chartIntervalos"></canvas>
	</div>
	<script>
		new Chart(document.getElementById('chartIntervalos'), {
			type: 'bar',
			data: {
				labels: [{{ range $k, $v := .DiasTrabajoMapHoras }}'{{ $k }}',{{ end }}],
				datasets: [{
					label: 'Horas',
					data: [{{ range $k, $v := .DiasTrabajoMapHoras }}{{ $v }},{{ end }}],
				}]
			},
		});
	</script>
	{{ end }}


	<!--? DIAS DE TRABAJO NUEVO -->
	{{ if .DiasTrabajo -}}
	<h3 class="mt-4 mb-4 text-xl text-cyan-600">Tiempo invertido</h3>
	<p>
		{{ with .PersonaCosto -}}
		Estimado total: {{ .SegundosEstimado }} <br>
		Invertido total: {{ .SegundosUtilizado }}
		{{ end }}
	</p>
	<div class="p-4 mb-4">
		<canvas id="chartDiasTrabajo"></canvas>
	</div>
	<script>
		new Chart(document.getElementById('chartDiasTrabajo'), {
			type: 'bar',
			options: {
				scales: {
					x: {
						stacked: true,
					},
					y: {
						stacked: true
					}
				}
			},
			data: {
				labels: [{{ range .DiasTrabajo }}{{ if .Segundos }}'{{ .Fecha }}',{{ end }}{{ end }}],
				datasets: [
					{{ range $proyectoID, $v := $.Proyectos -}}
					{
						label: '{{ .Proyecto.Titulo }} {{ segundosToString .Segundos }}',
						data: [{{ range $.DiasTrabajo }}{{ if .Segundos }}{{ range .Proyectos }}{{ $horas := 0.0 }}{{ if eq $proyectoID .Proyecto.ProyectoID }}{{ $horas = .Horas }}{{ end }}{{ $horas }},{{ end }}{{ end }}{{ end }}],
					},
					{{ end }}
				]
			},
		});
	</script>
	{{ end }}

	{{ range $.Proyectos }}
	<p>
		{{ .Proyecto.Titulo }}: {{ segundosToString .Segundos }} ({{ .Segundos }}s)
	</p>
	{{ end }}

	<div id="tablaDias" class="overflow-x-auto max-h-96">
		<table class="p-4 border border-separate border-cyan-600">
			<thead>
				<tr>
					<th>#</th>
					<th>Fecha</th>
					<th>Total</th>
					{{ range $.Proyectos }}
					<th>{{ .Proyecto.Titulo }}</th>
					{{ end }}
				</tr>
			</thead>
			<tbody class="">
				{{ range $idx, $dia := .DiasTrabajo }}
				<tr>
					<td>{{ suma $idx 1 }}</td>
					<td class="bg-cyan-950 text-nowrap">{{ .Fecha }}</td>
					<td class="bg-cyan-950">{{ segundosToString .Segundos }}</td>

					{{ range $proyectoID, $v := .Proyectos -}}
						{{ $horas := 0.0 }}{{ if eq $proyectoID .Proyecto.ProyectoID }}{{ $horas = .Horas }}{{ end }}
						<td class="bg-cyan-950 text-nowrap">
							{{ .Proyecto.ProyectoID }} {{ segundosToString .Segundos }}
						</td>
					{{ end }}
				</tr>
				{{ end }}
			</tbody>
		</table>
	</div>


	<h3 class="mt-4 mb-4 text-xl text-cyan-600">Días de trabajo</h3>
	{{ range .DiasTrabajo -}}
	{{ if .Segundos -}}
	<div class="p-2 mb-2">
		<h3 class="">
			{{ .Fecha }}
			<span class="inline-block w-16 px-2 py-1 text-xs font-semibold text-center text-cyan-600 bg-cyan-950 rounded-md">{{ segundosToString .Segundos }}</span>
		</h3>
		{{ range .Proyectos -}}
		<div class="pl-4">
			<h4 class="py-1 text-xl font-bold text-cyan-600">
				{{ .Proyecto.Titulo }}
				<span class="inline-block w-16 px-2 py-1 text-xs font-semibold text-center text-cyan-600 bg-cyan-950 rounded-md">{{ segundosToString .Segundos }}</span>
			</h4>
			{{ range .Historias -}}
			<div>
				<p class="py-1 pt-2 text-base font-bold">
					<span class="inline-block w-16 px-2 py-1 text-xs font-semibold text-center text-cyan-600 bg-cyan-950 rounded-md">{{ segundosToString .Segundos }}</span>
					<a
						href="/historias/{{ .Historia.HistoriaID }}"
						class="transition-colors hover:text-cyan-400">
						{{ enfatizar .Historia.Titulo }}
					</a>
				</p>
				{{ range .Tareas -}}
				<div>
					<p class="py-1 pl-16 text-sm opacity-75">
						<span class="inline-block w-16 px-2 py-0 text-xs font-semibold text-center text-cyan-600 bg-cyan-950 rounded-md">{{ segundosToString .Segundos }}</span>
						<a
							href="/historias/{{ .Tarea.HistoriaID }}#{{ .Tarea.TareaID }}"
							class="transition-colors hover:text-cyan-400">
							<span class="inline-block w-6 text-center">
								{{- if .Tarea.Finalizada }}<i class="text-green-600 fa-regular fa-square-check"></i>
								{{ else if .Tarea.EnCurso }}<i class="text-green-600 fa-regular fa-square"></i>
								{{ else if .Tarea.EnPausa }}<i class="text-orange-600 fa-regular fa-square"></i>
								{{ else }}<i class="text-slate-400 fa-regular fa-square"></i>
								{{ end -}}
							</span>
							 {{ enfatizar .Tarea.Descripcion }}
						</a>
					</p>
				</div>
				{{ end }}
			</div>
			{{ end }}
		</div>
		{{ end }}
	</div>
	{{ end }}
	{{ end }}

</main>
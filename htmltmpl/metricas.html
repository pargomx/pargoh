<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<h3 class="mt-4 text-xl text-white text-center">
	Últimos 7 días de trabajo
</h3>
<div class="flex grow items-center justify-center p-2">

	<div class="p-2 bg-cyan-900 rounded-md w-full overflow-x-auto max-w-2xl shadow-md">
		{{/* El gráfico es 480x810. w/h=auto lo hace escalable.
			Viewbox:y=25,h=810-25 reduce primera fila sin afectar coordenadas.  */ -}}
		<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 25 480 785">
			<!-- Fondo -->
			<rect x="0" y="0" width="480" height="810" fill="white" />

			<!-- Horizontales principales (3 horas) -->
			<g stroke="lightgray" stroke-width="1">
				<!-- <line id="lh_0" x1="0" y1="000" x2="480" y2="000" /> -->
				<line id="lh_1" x1="0" y1="090" x2="480" y2="090" />
				<line id="lh_2" x1="0" y1="180" x2="480" y2="180" />
				<line id="lh_3" x1="0" y1="270" x2="480" y2="270" />
				<line id="lh_4" x1="0" y1="360" x2="480" y2="360" />
				<line id="lh_5" x1="0" y1="450" x2="480" y2="450" />
				<line id="lh_6" x1="0" y1="540" x2="480" y2="540" />
				<line id="lh_7" x1="0" y1="630" x2="480" y2="630" />
				<line id="lh_8" x1="0" y1="720" x2="480" y2="720" />
				<!-- <line id="lh_9" x1="0" y1="810" x2="480" y2="810" /> -->
			</g>

			<!-- Horizontales secundarias (horas) -->
			<g stroke="lightgray" stroke-width="1" stroke-dasharray="4">
				<line id="lha_1" x1="30" y1="120" x2="480" y2="120" />
				<line id="lha_2" x1="30" y1="210" x2="480" y2="210" />
				<line id="lha_3" x1="30" y1="300" x2="480" y2="300" />
				<line id="lha_4" x1="30" y1="390" x2="480" y2="390" />
				<line id="lha_5" x1="30" y1="480" x2="480" y2="480" />
				<line id="lha_6" x1="30" y1="570" x2="480" y2="570" />
				<line id="lha_7" x1="30" y1="660" x2="480" y2="660" />
				<line id="lha_8" x1="30" y1="750" x2="480" y2="750" />

				<line id="lhb_1" x1="30" y1="150" x2="480" y2="150" />
				<line id="lhb_2" x1="30" y1="240" x2="480" y2="240" />
				<line id="lhb_3" x1="30" y1="330" x2="480" y2="330" />
				<line id="lhb_4" x1="30" y1="420" x2="480" y2="420" />
				<line id="lhb_5" x1="30" y1="510" x2="480" y2="510" />
				<line id="lhb_6" x1="30" y1="600" x2="480" y2="600" />
				<line id="lhb_7" x1="30" y1="690" x2="480" y2="690" />
				<line id="lhb_8" x1="30" y1="780" x2="480" y2="780" />
			</g>

			<!-- Verticales (semana) -->
			<g stroke="gray" stroke-width="1">
				<!-- <line id="lv_1" x1="000" y1="0" x2="000" y2="810" /> -->
				<line id="lv_1" x1="060" y1="0" x2="060" y2="810" />
				<line id="lv_2" x1="120" y1="0" x2="120" y2="810" />
				<line id="lv_3" x1="180" y1="0" x2="180" y2="810" />
				<line id="lv_4" x1="240" y1="0" x2="240" y2="810" />
				<line id="lv_5" x1="300" y1="0" x2="300" y2="810" />
				<line id="lv_6" x1="360" y1="0" x2="360" y2="810" />
				<line id="lv_7" x1="420" y1="0" x2="420" y2="810" />
				<!-- <line id="lv_8" x1="480" y1="0" x2="480" y2="810" /> -->
			</g>

			{{ if .Semana }}
			<!-- Etiqueta para la fecha -->
			<text id="dia_1" x="090" y="75" font-size="12" text-anchor="middle">{{ (index .Semana 0).GetFechaAbrev }}</text>
			<text id="dia_2" x="150" y="75" font-size="12" text-anchor="middle">{{ (index .Semana 1).GetFechaAbrev }}</text>
			<text id="dia_3" x="210" y="75" font-size="12" text-anchor="middle">{{ (index .Semana 2).GetFechaAbrev }}</text>
			<text id="dia_4" x="270" y="75" font-size="12" text-anchor="middle">{{ (index .Semana 3).GetFechaAbrev }}</text>
			<text id="dia_5" x="330" y="75" font-size="12" text-anchor="middle">{{ (index .Semana 4).GetFechaAbrev }}</text>
			<text id="dia_6" x="390" y="75" font-size="12" text-anchor="middle">{{ (index .Semana 5).GetFechaAbrev }}</text>
			<text id="dia_7" x="450" y="75" font-size="12" text-anchor="middle">{{ (index .Semana 6).GetFechaAbrev }}</text>
			<!-- Etiqueta para el día -->
			<text id="dia_1" x="090" y="57" font-size="18" text-anchor="middle">{{ (index .Semana 0).GetDiaSemanaAbrev }}</text>
			<text id="dia_2" x="150" y="57" font-size="18" text-anchor="middle">{{ (index .Semana 1).GetDiaSemanaAbrev }}</text>
			<text id="dia_3" x="210" y="57" font-size="18" text-anchor="middle">{{ (index .Semana 2).GetDiaSemanaAbrev }}</text>
			<text id="dia_4" x="270" y="57" font-size="18" text-anchor="middle">{{ (index .Semana 3).GetDiaSemanaAbrev }}</text>
			<text id="dia_5" x="330" y="57" font-size="18" text-anchor="middle">{{ (index .Semana 4).GetDiaSemanaAbrev }}</text>
			<text id="dia_6" x="390" y="57" font-size="18" text-anchor="middle">{{ (index .Semana 5).GetDiaSemanaAbrev }}</text>
			<text id="dia_7" x="450" y="57" font-size="18" text-anchor="middle">{{ (index .Semana 6).GetDiaSemanaAbrev }}</text>
			{{ else }}
			<!-- Fallback -->
			<text id="dia_1" x="090" y="22" font-size="18" text-anchor="middle">Lun</text>
			<text id="dia_2" x="150" y="22" font-size="18" text-anchor="middle">Mar</text>
			<text id="dia_3" x="210" y="22" font-size="18" text-anchor="middle">Mié</text>
			<text id="dia_4" x="270" y="22" font-size="18" text-anchor="middle">Jue</text>
			<text id="dia_5" x="330" y="22" font-size="18" text-anchor="middle">Vie</text>
			<text id="dia_6" x="390" y="22" font-size="18" text-anchor="middle">Sáb</text>
			<text id="dia_7" x="450" y="22" font-size="18" text-anchor="middle">Dom</text>
			{{ end }}

			<!-- Etiquetas de hora -->
			<text id="hra_1" x="30" y="105" font-size="12" text-anchor="middle">06:00am</text>
			<text id="hra_2" x="30" y="195" font-size="12" text-anchor="middle">09:00am</text>
			<text id="hra_3" x="30" y="285" font-size="12" text-anchor="middle">12:00pm</text>
			<text id="hra_4" x="30" y="375" font-size="12" text-anchor="middle">03:00pm</text>
			<text id="hra_5" x="30" y="465" font-size="12" text-anchor="middle">06:00pm</text>
			<text id="hra_6" x="30" y="555" font-size="12" text-anchor="middle">09:00pm</text>
			<text id="hra_7" x="30" y="645" font-size="12" text-anchor="middle">12:00am</text>
			<text id="hra_8" x="30" y="735" font-size="12" text-anchor="middle">03:00am</text>

			<!-- Intervalos por proyecto -->
			{{ range $diaIdx, $sem := .Semana -}}
			{{ $diaNum := suma $diaIdx 1 -}}
			{{ range .Proyectos -}}{{ $color := .Proyecto.Color }}
			{{ range .Historias -}}
			{{ range .Tareas -}}
			{{ range .Intervalos -}}
			<rect x="{{ suma (mult $diaNum 60) 4 }}" y="{{ div .MinutosSince6am 2 }}" width="52" height="{{ div .Segundos 120 }}" fill="{{ $color }}"></rect>
			{{ end -}}
			{{ end -}}
			{{ end -}}
			{{ end -}}
			{{ end }}

			<!-- Marca de la hora actual -->
			{{ with .Ahora }}
			<rect x="420" y="{{ div .MinutosSince6am 2 }}" width="60" height="4" fill="green"></rect>
			{{ end }}
		</svg>
		<p class="font-mono text-sm text-center pt-2">
			{{ .Ahora.Time }}
		</p>
	</div>

</div>

<!-- DEBUG INTERVALOS EN GRÁFICO SEMANAL -->
<table class="font-mono text-right hidden">
	<thead>
		<th>Fecha</th>
		<th>Inicio</th>
		<th>Fin</th>
		<th>Start min</th>
		<th>Start px</th>
		<th>Dur seg</th>
		<th>Dur px</th>
	</thead>
	<tbody>
	{{ range .Semana }}
	{{ range .Proyectos }}
	{{ range .Historias }}
	{{ range .Tareas }}
	{{ range .Intervalos }}
	<tr>
		<td>
			{{ .Fecha }}
		</td>
		<td>
			{{ .Inicio }}
		</td>
		<td>
			{{ .Fin }}
		</td>
		<td>
			{{ .MinutosSince6am }}
		</td>
		<td>
			{{ div .MinutosSince6am 2 }}
		</td>
		<td>
			{{ .Segundos }}
		</td>
		<td>
			{{ div .Segundos 120 }}
		</td>
	</tr>
	{{ end }}
	{{ end }}
	{{ end }}
	{{ end }}
	{{ end }}
	</tbody>
</table>

<main class="grow w-full p-2">

	<!--? DIAS DE TRABAJO -->
	{{ if .DiasTrabajo -}}
	<h3 class="mt-4 mb-4 text-xl text-cyan-600">
		Tiempo invertido: Días en general
	</h3>
	<p>
		{{ with .PersonaCosto -}}
		Estimado total: {{ .SegundosEstimado }} <br>
		Invertido total: {{ .SegundosUtilizado }}
		{{ end }}
	</p>
	<div class="p-4 mb-4">
		<canvas id="chartDiasTrabajoOld"></canvas>
	</div>
	<script>
		new Chart(document.getElementById('chartDiasTrabajoOld'), {
			type: 'bar',
			data: {
				labels: [{{ range .DiasTrabajo }}'{{ .Fecha }}',{{ end }}],
				datasets: [
					{
						label: 'Horas2',
						data: [{{ range .DiasTrabajo }}{{ .Horas }},{{ end }}],
					},
				]
			},
		});
	</script>
	{{ end }}

	<!--? DIAS DE TRABAJO OLD -->
	{{ if .DiasTrabajoMapHoras -}}
	<h3 class="mt-4 mb-4 text-xl text-cyan-600">
		Tiempo invertido: Días con horas de trabajo
	</h3>
	<p>
		{{ with .PersonaCosto -}}
		Estimado total: {{ .SegundosEstimado }} <br>
		Invertido total: {{ .SegundosUtilizado }}
		{{ end }}
	</p>
	<div class="p-4 mb-4">
		<canvas id="chartIntervalos"></canvas>
	</div>
	<script>
		new Chart(document.getElementById('chartIntervalos'), {
			type: 'bar',
			data: {
				labels: [{{ range $k, $v := .DiasTrabajoMapHoras }}'{{ $k }}',{{ end }}],
				datasets: [{
					label: 'Horas',
					data: [{{ range $k, $v := .DiasTrabajoMapHoras }}{{ $v }},{{ end }}],
				}]
			},
		});
	</script>
	{{ end }}


	<!--? DIAS DE TRABAJO NUEVO -->
	{{ if .DiasTrabajo -}}
	<h3 class="mt-4 mb-4 text-xl text-cyan-600">Tiempo invertido</h3>
	<p>
		{{ with .PersonaCosto -}}
		Estimado total: {{ .SegundosEstimado }} <br>
		Invertido total: {{ .SegundosUtilizado }}
		{{ end }}
	</p>
	<div class="p-4 mb-4">
		<canvas id="chartDiasTrabajo"></canvas>
	</div>
	<script>
		new Chart(document.getElementById('chartDiasTrabajo'), {
			type: 'bar',
			options: {
				scales: {
					x: {
						stacked: true,
					},
					y: {
						stacked: true
					}
				}
			},
			data: {
				labels: [{{ range .DiasTrabajo }}{{ if .Segundos }}'{{ .Fecha }}',{{ end }}{{ end }}],
				datasets: [
					{{ range $proyectoID, $v := $.Proyectos -}}
					{
						label: '{{ .Proyecto.Titulo }} {{ segundosToString .Segundos }}',
						data: [{{ range $.DiasTrabajo }}{{ if .Segundos }}{{ range .Proyectos }}{{ $horas := 0.0 }}{{ if eq $proyectoID .Proyecto.ProyectoID }}{{ $horas = .Horas }}{{ end }}{{ $horas }},{{ end }}{{ end }}{{ end }}],
					},
					{{ end }}
				]
			},
		});
	</script>
	{{ end }}

	{{ range $.Proyectos }}
	<p>
		{{ .Proyecto.Titulo }}: {{ segundosToString .Segundos }} ({{ .Segundos }}s)
	</p>
	{{ end }}

	<div id="tablaDias" class="overflow-x-auto max-h-96">
		<table class="p-4 border border-separate border-cyan-600">
			<thead>
				<tr>
					<th>#</th>
					<th>Fecha</th>
					<th>Total</th>
					{{ range $.Proyectos }}
					<th>{{ .Proyecto.Titulo }}</th>
					{{ end }}
				</tr>
			</thead>
			<tbody class="">
				{{ range $idx, $dia := .DiasTrabajo }}
				<tr>
					<td>{{ suma $idx 1 }}</td>
					<td class="bg-cyan-950 text-nowrap">{{ .Fecha }}</td>
					<td class="bg-cyan-950">{{ segundosToString .Segundos }}</td>

					{{ range $proyectoID, $v := .Proyectos -}}
						{{ $horas := 0.0 }}{{ if eq $proyectoID .Proyecto.ProyectoID }}{{ $horas = .Horas }}{{ end }}
						<td class="bg-cyan-950 text-nowrap">
							{{ .Proyecto.ProyectoID }} {{ segundosToString .Segundos }}
						</td>
					{{ end }}
				</tr>
				{{ end }}
			</tbody>
		</table>
	</div>


	<h3 class="mt-4 mb-4 text-xl text-cyan-600">Días de trabajo</h3>
	{{ range .DiasTrabajo -}}
	{{ if .Segundos -}}
	<div class="p-2 mb-2">
		<h3 class="">
			{{ .Fecha }}
			<span class="inline-block w-16 px-2 py-1 text-xs font-semibold text-center text-cyan-600 bg-cyan-950 rounded-md">{{ segundosToString .Segundos }}</span>
		</h3>
		{{ range .Proyectos -}}
		<div class="pl-4">
			<h4 class="py-1 text-xl font-bold text-cyan-600">
				{{ .Proyecto.Titulo }}
				<span class="inline-block w-16 px-2 py-1 text-xs font-semibold text-center text-cyan-600 bg-cyan-950 rounded-md">{{ segundosToString .Segundos }}</span>
			</h4>
			{{ range .Historias -}}
			<div>
				<p class="py-1 pt-2 text-base font-bold">
					<span class="inline-block w-16 px-2 py-1 text-xs font-semibold text-center text-cyan-600 bg-cyan-950 rounded-md">{{ segundosToString .Segundos }}</span>
					<a
						href="/historias/{{ .Historia.HistoriaID }}"
						class="transition-colors hover:text-cyan-400">
						{{ enfatizar .Historia.Titulo }}
					</a>
				</p>
				{{ range .Tareas -}}
				<div>
					<p class="py-1 pl-16 text-sm opacity-75">
						<span class="inline-block w-16 px-2 py-0 text-xs font-semibold text-center text-cyan-600 bg-cyan-950 rounded-md">{{ segundosToString .Segundos }}</span>
						<a
							href="/historias/{{ .Tarea.HistoriaID }}#{{ .Tarea.TareaID }}"
							class="transition-colors hover:text-cyan-400">
							<span class="inline-block w-6 text-center">
								{{- if .Tarea.Finalizada }}<i class="text-green-600 fa-regular fa-square-check"></i>
								{{ else if .Tarea.EnCurso }}<i class="text-green-600 fa-regular fa-square"></i>
								{{ else if .Tarea.EnPausa }}<i class="text-orange-600 fa-regular fa-square"></i>
								{{ else }}<i class="text-slate-400 fa-regular fa-square"></i>
								{{ end -}}
							</span>
							 {{ enfatizar .Tarea.Descripcion }}
						</a>
					</p>
				</div>
				{{ end }}
			</div>
			{{ end }}
		</div>
		{{ end }}
	</div>
	{{ end }}
	{{ end }}

</main>
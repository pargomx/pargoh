<header class="relative flex items-center w-full bg-cyan-950 shadow-lg">
	<div class="p-1">
		<img
			data-proyecto-id="{{ .Proyecto.ProyectoID }}"
			src="{{ if .Proyecto.Imagen }}/imagenes/{{ .Proyecto.Imagen }}{{ else }}/assets/img/Elegantthemes-Softies-Tools.256.png{{ end }}"
			alt="Portada del proyecto"
			class="w-24 rounded-md">
	</div>
	<div class="w-full p-2">
		<h2 class="text-2xl font-medium">
			<a href="/proyectos/{{ .Proyecto.ProyectoID }}">
				{{ .Proyecto.Titulo }}
			</a>
		</h2>
		<h3 class="flex items-center gap-1 py-1">
			<span class="px-2 py-1 font-mono text-sm bg-black bg-opacity-40 rounded-md"><i class="fa-solid fa-person"></i></span>
			<span class="text-xl">{{ .Persona.Nombre }}</span>
		</h3>
	</div>
	<span class="absolute right-2 top-2">
		<a href="/" class="px-2 py-1 transition-opacity bg-red-800 rounded-md opacity-75 hover:opacity-100"><i class="fa-solid fa-xmark"></i></a>
	</span>
</header>

<main class="grow w-full max-w-5xl p-2 mx-auto">
	<h3 class="mb-2 text-xl text-cyan-600">Personaje</h3>
	<div class="mt-4 mb-2 text-center text-7xl">
		<i class="fa-solid fa-user"></i>
	</div>
	<h4 class="mb-1 text-xl font-semibold text-center">
		{{ .Persona.Nombre }}
	</h4>
	<div class="mb-4">
		<textarea
			id="personaDesc"
			hx-patch="/personas/{{ .Persona.PersonaID }}/descripcion"
			hx-swap="none"
			hx-trigger="change, keyup changed delay:2s"
			name="value"
			rows="1"
			placeholder="Descripción del personaje..." 
			class="w-full px-2 py-1 text-sm font-medium text-center transition-opacity bg-transparent border-b border-cyan-800 outline-none opacity-75 max-h-96 focus:opacity-100 focus:border-blue-400 placeholder:text-slate-600">
			{{- .Persona.Descripcion -}}
		</textarea>
	</div>

	<h3 class="mb-4 text-xl text-cyan-600">Historias de usuario
		<button
			onclick="document.getElementById('input_AddHistoria').focus()"
			class="float-right px-3 transition-opacity opacity-75 hover:opacity-100">
			<i class="fa-solid fa-square-plus"></i>
		</button>
	</h3>
	<div
		tipo="sort_historias" 
		hx-get="/personas/{{ .Persona.PersonaID }}" 
		hx-trigger="historiasActualizadas" 
		hx-target="this" hx-swap="innerHTML" 
		hx-select="[tipo='sort_historias'] > *" 
		class="flex flex-col items-stretch gap-4 pb-2">

		{{ range .Historias -}}
		<article
			tipo="sort_historia"
			id="{{ .HistoriaID }}"
			class="flex items-center bg-cyan-950 border-2 rounded-md shadow-lg {{- if eq .Prioridad 3 }} border-cyan-800 {{ else if eq .Prioridad 2 }} border-cyan-900 bg-cyan-950 opacity-75 {{ else if eq .Prioridad 1 }} border-cyan-600 bg-transparent opacity-75 {{ else }} border-cyan-900 bg-transparent opacity-75 {{ end }}">
			<span tipo="sort_handle" class="p-3 cursor-pointer">
				<i class="fa-solid fa-grip-vertical"></i>
			</span>
			<a href="/historias/{{ .HistoriaID }}" class="grow py-2">
				{{ enfatizar .Titulo }}
			</a>
			<span class="p-3">
				{{- if .Completada }}<i class="text-green-600 fa-solid fa-circle-check"></i>
				{{- else if eq .Prioridad 3 }}<i class="text-orange-600 fa-solid fa-angles-up"></i>
				{{- else if eq .Prioridad 2 }}<i class="text-orange-400 fa-solid fa-chevron-up"></i>
				{{- else if eq .Prioridad 1 }}<i class="text-orange-200 fa-solid fa-minus"></i>
				{{- end }}
			</span>
		</article>
		{{ end -}}

		<!-- Agregar historia -->
		<div>
			<textarea
				id="input_AddHistoria"
				hx-post="/nodos/{{ with .Abuelo }}{{ .HistoriaID }}{{ else }}{{ .Persona.PersonaID }}{{ end }}"
				hx-target="#msgStack"
				hx-trigger="keyup[key=='Enter']"
				name="titulo" 
				rows="1"
				enterkeyhint="done"
				placeholder="Agregar historia..."
				class="inline-block w-full p-2 bg-transparent border-b border-cyan-800 outline-none text-white/50 focus:text-white read-only:border-transparent invalid:border-red-500 invalid:focus:border-red-500 placeholder:text-slate-600 read-only:focus:border-transparent focus:border-blue-400"></textarea>
		</div>
	</div>

	<!-- DESCRIPCIÓN DE LA PERSONA -->

	{{ if .Persona.Descripcion -}}
	<!-- <details class="py-4">
		<summary class="opacity-75">Mapa de empatía</summary>
		<p class="opacity-50">
			{{ .Persona.Descripcion }}
		</p>
	</details> -->
	{{ end }}


</main>

<div id="ctxMenu" tipo="ctxMenu" gk-historia="" class="absolute hidden p-2 text-black bg-cyan-50 rounded shadow-md">
	<div class="grid grid-cols-2 gap-1 text-sm">
		<div class="col-span-2 text-xs opacity-50">Acciones</div>
		<button type="button" onclick="tableroHistoria()" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">📋 Tablero</button>
		<button type="button" onclick="editarHistoria()" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">✏️ Editar</button>
		<button type="button" onclick="moverHistoria()" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">🚙 Mover</button>
		<button type="button" onclick="eliminarHistoria()" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">❌ Eliminar</button>
		<div class="col-span-2 text-xs opacity-50">Prioridad</div>
		<button type="button" onclick="priorizarHistoria(3)" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">🤩 Must</button>
		<button type="button" onclick="priorizarHistoria(2)" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">🤔 Should</button>
		<button type="button" onclick="priorizarHistoria(1)" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">😶‍🌫️ Would</button>
		<button type="button" onclick="priorizarHistoria(0)" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">🚫 Won't</button>
		<div class="col-span-2 text-xs opacity-50">Estatus</div>
		<button type="button" onclick="marcarHistoria(1)" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">✅ Okey</button>
		<button type="button" onclick="marcarHistoria(0)" class="block w-full py-1 pl-2 pr-4 text-left rounded hover:bg-gray-300">🔻 Falta</button>
	</div>
</div>

<dialog id="dialogHistoria" hx-get="" hx-swap="innerHTML" hx-trigger="loadHistoriaForm" hx-target="this" class="text-white bg-cyan-900 border-4 border-cyan-800 rounded-md">
	<!-- Loaded from editarHistoria() -->
	Cargando...
</dialog>

<div id="msgStack" class="hidden">
	<!-- Mensajes respuesta del servidor, utilizado para hacer trigger a reload -->
</div>

<!-- ======================================================== -->
<script>
	function tableroHistoria() {
		let historiaID = document.querySelector("[tipo='ctxMenu']").getAttribute("gk-historia")
		window.location.href = `/tablero/${historiaID}`
	}

	function moverHistoria() {
		let historiaID = document.querySelector("[tipo='ctxMenu']").getAttribute("gk-historia")
		window.location.href = `/historias/${historiaID}/mover`
	}

	function priorizarHistoria(prioridad) {
		if (isNaN(prioridad)) {
			alert("La prioridad debe ser un número")
			return console.error("La prioridad debe ser un número")
		}
		let historiaID = document.querySelector("[tipo='ctxMenu']").getAttribute("gk-historia")
		let formData = new FormData();
		formData.append("prioridad", prioridad);
		fetch(`/historias/${historiaID}/priorizar`, { method: 'POST', body: formData }).then(response => handleResponse(response));
	}

	function marcarHistoria(completada) {
		let historiaID = document.querySelector("[tipo='ctxMenu']").getAttribute("gk-historia")
		let formData = new FormData();
		formData.append("completada", completada);
		fetch(`/historias/${historiaID}/marcar`, { method: 'POST', body: formData }).then(response => handleResponse(response));
	}

	function eliminarHistoria() {
		let historiaID = document.querySelector("[tipo='ctxMenu']").getAttribute("gk-historia")
		let formData = new FormData();
		fetch(`/historias/${historiaID}`, { method: 'DELETE' }).then(response => handleResponse(response));
	}

	function editarHistoria() {
		let historiaID = document.querySelector("[tipo='ctxMenu']").getAttribute("gk-historia")
		let dialog = document.getElementById("dialogHistoria")
		dialog.showModal()
		dialog.setAttribute("hx-get", `/historias/${historiaID}/form`)
		htmx.process(dialog)
		dialog.dispatchEvent(new Event("loadHistoriaForm"))
	}

	// ================================================================ //
	// ========== Context menu ======================================== //

	function setupMenuContextual(element, historiaID) {
		element.addEventListener("contextmenu", function(event) {
			event.preventDefault()
			let menu = document.querySelector("[tipo='ctxMenu']")
			menu.classList.remove("hidden")
			let menuW = menu.offsetWidth // Dimensiones del menú
			let menuH = menu.offsetHeight
			let winW = window.innerWidth // Dimensiones de la ventana
			let winH = window.innerHeight
			let x = event.clientX // Coordenadas dentro de la ventana
			let y = event.clientY
			if (x + menuW > winW) { x = winW - menuW } // Que no salga de la ventana
			if (y + menuH > winH) { y = winH - menuH }
			menu.style.left = `${x}px`
			menu.style.top = `${y}px`

			menu.setAttribute("gk-historia", historiaID)
		})
	}
	// Cerrar el menú contextual al hacer click en donde sea.
	document.addEventListener("click", function(event) {
		let menu = document.querySelector("[tipo='ctxMenu']")
		if (menu.classList.contains("hidden")) { return }
		menu.classList.add("hidden")
	})

	// ================================================================ //
	// ========== Recargar contenido ================================== //

	// Para respuestas a solicitudes hechas con JS.
	function handleResponse(response) {
		response.text().then((msg) => {
			if (response.status >= 200 && response.status < 300) {
				console.log(msg)
			} else {
				alert(msg)
			}
			document.querySelector("[tipo='sort_historias']").dispatchEvent(new Event("historiasActualizadas"))
		})
	}

	// Para respuestas a solicitudes hechas con HTMX.
	document.getElementById("msgStack").addEventListener("htmx:afterSwap", (event) => {
		document.querySelector("[tipo='sort_historias']").dispatchEvent(new Event("historiasActualizadas"))
		dialogHistoria.close()
	})

	// Ubicar una historia seleccionada mediante el URL fragment.
	if (window.location.hash) {
		let historia = document.getElementById(window.location.hash.substr(1));
		if (historia != null) {
			historia.classList.add("border-indigo-600");
			historia.classList.add("border-2");
			historia.scrollIntoView();
		}
	}

	// ================================================================ //
	// ========== Inicializar ========================================= //
	
	htmx.onLoad(function(content) {
		content.querySelectorAll("[tipo='sort_historia']").forEach(element => {
			setupMenuContextual(element, element.id) // al cargar toda la página
		});
		if (content.getAttribute("tipo") == "sort_historia") {
			setupMenuContextual(content, content.id) // al cargar individualmente cada historia
		}
	});

	// ================================================================ //
	// ========== Reordenar =========================================== //

	function reordenarHistoria(historiaID, newPosicion) {
		console.debug(`reordenarHistoria(id:${historiaID}, pos:${newPosicion})`)
		if (historiaID == null) {
			return console.error("No se puede reordenar sin ID")
		}
		let formData = new FormData();
		formData.append("newPosicion", newPosicion);
		fetch(`/nodos/${historiaID}/reordenar`, { method: 'POST', body: formData }).then(response => handleResponse(response));
	}

	var zonaCarriles = new Sortable(document.querySelector("[tipo='sort_historias']"), {
		group: "historias", animation: 150, swapThreshold: 0.50,
		draggable: "[tipo='sort_historia']",
		handle: "[tipo='sort_handle']",
		ghostClass: "opacity-50",
		onEnd: function(event) {
			let historiaID = event.item.id
			if (historiaID == null) { 
				return console.error("historiaID null") 
			}
			if (event.oldIndex != event.newIndex){
				return reordenarHistoria(historiaID, event.newIndex + 1)
			}
		},
	});

</script>
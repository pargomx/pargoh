<h2 class="p-3 text-3xl text-center">
	Pargo üêü
</h2>

<main class="flex flex-col items-center justify-center grow w-full max-w-5xl gap-4 p-2 mx-auto">
	{{ range .Proyectos -}}
	<article id="{{ .ProyectoID }}" class="relative flex items-center w-full bg-cyan-950 rounded-md shadow-lg">

		<div class="p-2 rounded-md">
			<a href="/proyectos/{{ .ProyectoID }}" hx-boost="true" hx-push-url="true">
				<img src="{{ if .Imagen }}/imagenes/{{ .Imagen }}{{ else }}/assets/img/Elegantthemes-Softies-Tools.256.png{{ end }}" alt="Portada del proyecto" class="w-32 transition-opacity rounded-md hover:opacity-75">
			</a>
		</div>

		<div class="w-full p-2">
			<h4 class="mb-2 text-2xl font-medium">
				<a href="/proyectos/{{ .ProyectoID }}" class="transition-opacity hover:opacity-75">{{ .Titulo }}</a>
			</h4>
			<p class="mb-2 text-sm opacity-75 line-clamp-3">
				{{- .Descripcion -}}
			</p>
			<ul class="flex flex-wrap pl-4 mb-2 list-disc gap-x-6 gap-y-1">
				{{ range .Personas -}}
				<li class="text-sm">
					<a href="/personas/{{ .PersonaID}}" class="transition-opacity opacity-75 hover:opacity-100">
						{{ .Nombre }}
					</a>
				</li>
				{{ end }}
			</ul>
		</div>

		<button 
			type="button"
			onclick="showProyectoForm(this.closest('article').id)"
			title="Editar proyecto"
			class="absolute top-0 right-0 px-1 transition-opacity bg-cyan-900 opacity-75 hover:opacity-100 rounded-tr-md rounded-bl-md">
			<i class="px-2 py-2 fa fa-pen"></i>
		</button>
	</article>
	{{ end }}

	{{ if not .Proyectos -}}
	<button
		type="button"
		onclick="showProyectoForm('New')"
		class="px-2 py-1 bg-cyan-700 rounded-full">
		Nuevo proyecto <i class="fa-solid fa-plus"></i>
	</button>
	{{ else }}
	<button
		type="button"
		onclick="showProyectoForm('New')"
		class="px-1 bg-cyan-700 rounded-full">
		<i class="fa-solid fa-plus"></i>
	</button>
	{{ end }}
</main>

<footer class="flex flex-col items-center gap-4 p-4">
	<p>Hecho con ‚ô° por PargoMx <i class="fa-solid fa-fish-fins"></i></p>
</footer>

<!--* NUEVO PROYECTO -->
<dialog id="frmPryNew" class="text-white bg-cyan-900 border-4 border-cyan-800 rounded-md">
	<header class="flex items-center gap-2 p-2 bg-cyan-800">
		<h2 class="grow text-xl">
			Nuevo proyecto
		</h2>
		<button
			type="button"
			onclick="this.closest('dialog').close()"
			title="Cerrar"
			class="inline-block float-right px-2 text-2xl rounded-md hover:opacity-75">
			<i class="fa-solid fa-xmark"></i>
		</button>
	</header>
	<div class="p-2 pb-0 text-right">
		<button
			type="button"
			onclick="frmPryNew.close(); importProyecto.showModal()"
			class="italic font-semibold text-cyan-500 underline transition-colors rounded hover:text-cyan-400 whitespace-nowrap">
			Importar JSON...
		</button>
	</div>
	<form class="flex flex-col gap-2 p-2" hx-post="/proyectos">
		<div>
			<label for="newprj_01">T√≠tulo</label>
			<input id="newprj_01" name="titulo" value="" type="text" class="form-control" required onchange="newprj_02.value=normalizar(this.value.replaceAll(' ',''))">
		</div>
		<div>
			<label for="newprj_02">Clave</label>
			<input id="newprj_02" name="clave" value="" type="text" class="form-control" required>
		</div>
		<div>
			<label for="newprj_03">Descripci√≥n</label>
			<textarea id="newprj_03" name="descripcion" rows="2" class="form-control"></textarea>
		</div>
		<button 
			type="submit"
			onclick="this.closest('dialog').close()"
			class="grow p-2 text-lg font-semibold transition-colors bg-cyan-700 rounded shadow-md hover:bg-cyan-600">
			Guardar
		</button>
	</form>
</dialog>

<!--* IMPORTAR -->
<dialog id="importProyecto" class="text-white bg-cyan-900 border-4 border-cyan-800 rounded-md">
	<header class="flex items-center gap-2 p-2 bg-cyan-800">
		<h2 class="grow text-xl">
			Importar proyecto
		</h2>
		<button
			type="button"
			onclick="this.closest('dialog').close()"
			title="Cerrar"
			class="inline-block float-right px-2 text-2xl rounded-md hover:opacity-75">
			<i class="fa-solid fa-xmark"></i>
		</button>
	</header>
	<form class="flex flex-col gap-2 p-2">
		<div class="py-2">
			<label for="importProyectoFile">JSON del proyecto</label>
			<input id="importProyectoFile" type="file" name="proyecto" accept="application/json" required class="form-control">
		</div>
		<button 
			type="button"
			hx-post="/proyectos/importar"
			hx-encoding="multipart/form-data"
			onclick="this.closest('dialog').close()"
			class="grow p-2 text-lg font-semibold transition-colors bg-cyan-700 rounded shadow-md hover:bg-cyan-600">
			Importar
		</button>
	</form>
</dialog>

{{ define "proyecto_form" }}
<dialog id="frmPry{{ .ProyectoID }}" class="{{ if gt (len .Descripcion) 500 }}w-full {{ end }}text-white bg-cyan-900 border-4 border-cyan-800 rounded-md">
	<header class="flex items-center gap-2 p-2 bg-cyan-800">
		<h2 class="grow text-xl">
			Modificar proyecto
		</h2>
		<button
			type="button"
			onclick="this.closest('dialog').close()"
			title="Cerrar"
			class="inline-block float-right px-2 text-2xl rounded-md hover:opacity-75">
			<i class="fa-solid fa-xmark"></i>
		</button>
	</header>
	<div class="flex flex-wrap justify-end p-2 pb-0 gap-x-4 gap-y-2">
		<a 
			href="/proyectos/{{ .ProyectoID}}/exportar.json"
			target="_blank"
			class="italic font-semibold text-cyan-500 underline transition-colors rounded hover:text-cyan-400 whitespace-nowrap">
			Exportar JSON
		</a>
		<a 
			href="/proyectos/{{ .ProyectoID}}/exportar.md"
			target="_blank"
			class="italic font-semibold text-cyan-500 underline transition-colors rounded hover:text-cyan-400 whitespace-nowrap">
			Exportar Markdown
		</a>
	</div>
	<form class="flex flex-col gap-2 p-2" hx-put="/proyectos/{{ .ProyectoID }}" hx-encoding="multipart/form-data">
		<div>
			<label for="{{ .ProyectoID }}_01">T√≠tulo</label>
			<input id="{{ .ProyectoID }}_01" name="titulo" value="{{ .Titulo }}" type="text" class="form-control" required>
		</div>
		<div>
			<label for="{{ .ProyectoID }}_02">Clave</label>
			<input id="{{ .ProyectoID }}_02" name="clave" value="{{ .ProyectoID }}" type="text" class="form-control" required>
		</div>
		<div>
			<label for="{{ .ProyectoID }}_03">Descripci√≥n</label>
			<textarea id="{{ .ProyectoID }}_03" name="descripcion" rows="1" class="form-control">{{ .Descripcion }}</textarea>
		</div>
		<div>
			<label for="{{ .ProyectoID }}_04">Imagen</label>
			<img tipo="img_preview" src="" class="hidden object-cover mx-auto mb-2 rounded-md shadow-lg aspect-square w-60">
			<input id="{{ .ProyectoID }}_04" type="file" name="imagen" accept="image/png, image/jpeg, image/gif" onchange="showImagen(this)" class="form-control">
		</div>
		<div class="flex flex-row-reverse pt-4 gap-x-4 gap-y-2">
			<button
				type="submit"
				onclick="this.closest('dialog').close()"
				class="grow p-2 text-lg font-semibold transition-colors bg-cyan-700 rounded shadow-md hover:bg-cyan-600">
				Guardar
			</button>
			<button
				type="button"
				hx-delete="/proyectos/{{ .ProyectoID}}"
				hx-confirm="¬øEliminar proyecto {{ .Titulo }}?"
				onclick="this.closest('dialog').close()"
				class="p-2 transition-opacity bg-red-800 rounded shadow-md opacity-75 hover:opacity-100 focus:opacity-100">
				Eliminar
			</button>
		</div>
	</form>
</dialog>
{{ end 	}}

{{ range .Proyectos }}
{{ template "proyecto_form" . }}
{{ end }}

<script>
	function showProyectoForm(proyectoID) {
		let form = document.getElementById(`frmPry${proyectoID}`);
		form.showModal();
		let input = form.querySelector("input");
		input.focus();
		input.setSelectionRange(input.value.length, input.value.length);
	}

	function showImagen(input) {
		const [file] = input.files
		if (file) {
			let img = input.closest("form").querySelector("img[tipo=img_preview]")
			img.classList.remove("hidden")
			img.classList.add("block")
			img.src = URL.createObjectURL(file)
		}
	}
</script>